---
title: 'ABCD: Puberty, Revision'
author: "Mark Fiecas"
date: "11/21/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries
```{r libraries,echo=FALSE,warning=FALSE,message=FALSE}
library(ggseg)
library(tidyverse)
library(lubridate)
library(lme4)
library(epiDisplay)
library(effectsize)
library(refund)
library(patchwork)
library(lmerTest)
library(kableExtra)
library(pixiedust)
library(gridExtra)
library(MuMIn)
library(performance)
library(table1)
library(ggstats)
```

## Loading data
```{r data,echo=FALSE}
# setwd('/Volumes/GoogleDrive-107651056577330384664/My Drive/Research/Collaborative/Cullen/ABCD/Puberty/')
# dat<-read.csv('~/Box/ABCD STUDY/ABCDStudy 3.0 Release/abcd_smrip101.txt',header=T, sep='\t') # load CT data from ABCD box folder
dat<-read.csv('~/Box/ABCD STUDY/ABCDStudy 4.0 Release/Raw data files/abcd_smrip10201.txt',header=T, sep='\t') # load CT data from ABCD box folder
deap.covars <- read.csv('~/Box/ABCD STUDY/ABCDStudy 4.0 Release/Raw data files/DEAP_covariates.csv',header=T,sep=',')
pdem02 <- read.csv('~/Box/ABCD STUDY/ABCDStudy 4.0 Release/Raw data files/pdem02.txt',header=T,sep='\t')
#dat.mriinfo <- read.csv('~/Box/ABCD STUDY/ABCDStudy 3.0 Release/abcd_mri01.txt',header=T,sep='\t')
#freesqc01 <- read.csv('~/Box/ABCD STUDY/ABCDStudy 3.0 Release/freesqc01.txt',header=T,sep='\t')
dat.mriinfo <- read.csv('~/Box/ABCD STUDY/ABCDStudy 4.0 Release/Raw data files/abcd_mri01.txt',header=T,sep='\t')
freesqc01 <- read.csv('~/Box/ABCD STUDY/ABCDStudy 4.0 Release/Raw data files/freesqc01.txt',header=T,sep='\t')
dtp<-readRDS('~/Downloads/umn-transition-jan062022-main/transition doc/puberty related/dtp.RData') # load PDS data that already sorted out
atlas_data <- read_atlas_files (
  subjects_dir = "/Applications/freesurfer/subjects/",
  atlas="aparc.stats")
dat<-dat[-1,]
pdem02 <- pdem02[-1,]
dat.mriinfo <- dat.mriinfo[-1,]
freesqc01 <-freesqc01[-1,]

# select the CT data across 34 Freesurfer Regions
ctr<-dat%>%dplyr::select(subjectkey,interview_age,
                         smri_thick_cdk_banksstslh:smri_thick_cdk_insularh)%>%
  arrange(subjectkey,interview_age)
names(ctr)[3:(34+2)] <- atlas_data$label[1:34] # A misnomer. CT data actually the average of LH and RH. See lines below.
# Take mean of left and right
for (i in 1:34) ctr[,2+i]=rowMeans(cbind(as.numeric(ctr[,2+i]),
                                         as.numeric(ctr[,2+34+i]))) 
ctr$interview_age=as.numeric(ctr$interview_age)
ctr <- ctr[,1:(2+34)] # Drop the RH data
```

## Utility function for merging data 
Now we merge all the data. This function will join all the different spreadsheets. The input is a data frame containing each subject's clinical outcome, and the output is an expanded data frame that adds on the demographic info, scanner info, etc to each subject. Note that some races are combined to create broader categories, some variables (race, ethnicity, income, MRI info) are only available at baseline, and some study participants were removed for various reasons (e.g., some info not available). Education information we take the parent and partner and take the higher value.
```{r, echo=FALSE,warning=FALSE,message=FALSE}
# Utility function on printing out how many kids removed at each filter step
print_filtered_rows <- function(dataframe, ...) {
  # Reference:
  # https://stackoverflow.com/questions/41021976/print-number-of-rows-filtered-out-by-dplyrs-filter-function
  df <- dataframe
  vars = as.list(substitute(list(...)))[-1L]
  for(arg in vars) {
    dataframe <- df
    dataframe_new <- dataframe %>% filter(!!arg)
    # rows_filtered <- nrow(df) - nrow(dataframe_new) # From original function
    rows_filtered = (df$subjectkey %>% unique() %>% length()) - (dataframe_new$subjectkey %>% unique() %>% length())
    #cat(sprintf('Filtered out %s subjects using: %s\n', rows_filtered, deparse(arg)))
    df = dataframe_new
  }
  return(dataframe_new)
}
merge_data = function(df.outcome = NULL){
  # Join the different spreadsheets
  # Note that we start with those who have CT data
  df.all <- ctr %>% 
                dplyr::select(subjectkey,interview_age,lh_bankssts:lh_insula) %>% 
    full_join(dtp %>% 
                distinct(.keep_all=TRUE) %>%
                dplyr::select(subjectkey,interview_age,pds), 
              by = c("subjectkey","interview_age"))
  if(!is.null(df.outcome)){
    df.all <- df.all %>% 
      left_join(df.outcome,
                by = c("subjectkey","interview_age"))
  }
  df.all <- df.all %>% 
    full_join(deap.covars %>% 
                filter(event_name %in% c('baseline_year_1_arm_1')) %>% # Cleaning up the covariate data, not the "final" data set. Thus, no need to print this out
                #dplyr::rename(subjectkey=subjectid,interview_age=age,eventname=event_name) %>%
                dplyr::rename(subjectkey=subjectid,interview_age=age) %>%
                dplyr::select(subjectkey,abcd_site,interview_age,rel_family_id), 
              by = c("subjectkey","interview_age")) %>%
    full_join(pdem02 %>%
                dplyr::select(subjectkey,interview_age,demo_sex_v2,demo_comb_income_v2,
                              demo_race_a_p___10:demo_race_a_p___25,demo_ethn_v2,
                              demo_prnt_marital_v2,demo_prnt_ed_v2,demo_prtnr_ed_v2) %>%
                mutate_at(vars(matches("demo_")),as.numeric) %>%
                mutate_at(vars(matches("demo_ethn_v2")),as.factor) %>%
                mutate_at(vars(matches("demo_sex_v2")),as.factor) %>%
                mutate_at(vars(matches("demo_comb_income_v2")),as.numeric) %>%
                mutate_at(vars(matches("demo_prnt_marital_v2")),as.factor) %>%
                mutate_at(vars(matches("demo_prnt_ed_v2")),as.factor) %>%
                mutate_at(vars(matches("demo_prtnr_ed_v2")),as.factor) %>%
                mutate_at(vars("interview_age"),as.numeric) %>%
                mutate(Race_White = if_else(demo_race_a_p___10 == 1,1,0),
                       Race_Black = if_else(demo_race_a_p___11 == 1,1,0),
                       Race_Native = if_else(demo_race_a_p___12 == 1 | 
                                               demo_race_a_p___13 == 1,1,0),
                       Race_PacificIslander = if_else(demo_race_a_p___14 == 1 | 
                                                        demo_race_a_p___15 == 1 |
                                                        demo_race_a_p___16 == 1 | 
                                                        demo_race_a_p___17 == 1 ,1,0),
                       Race_Asian = if_else(demo_race_a_p___18 == 1 |
                                              demo_race_a_p___19 == 1 |
                                              demo_race_a_p___20 == 1 |
                                              demo_race_a_p___21 == 1 |
                                              demo_race_a_p___22 == 1 |
                                              demo_race_a_p___23 == 1 |
                                              demo_race_a_p___24 == 1,1,0),
                       Race_Other = if_else(demo_race_a_p___25 == 1,1,0)),
              #by = c("subjectkey")) %>%
              by = c("subjectkey","interview_age")) %>%
    left_join(freesqc01 %>%
                dplyr::select(subjectkey,interview_age,fsqc_qc) %>%
                mutate_at(vars(c("interview_age","fsqc_qc")),as.numeric),
              by = c("subjectkey",'interview_age')) %>%
    left_join(dat.mriinfo %>%
                dplyr::select(subjectkey,interview_age,mri_info_manufacturer) %>%
                mutate_at(vars(c("interview_age")),as.numeric), 
                #distinct(subjectkey,.keep_all=TRUE),
              by = c("subjectkey",'interview_age'))
  
  # Dates and time elapsed
  custom_min = function(x){ # Workaround for the warnings when using min(x,na.rm=TRUE)
    if(length(x[which(!is.na(x))]) > 0){
      min(x,na.rm=TRUE)
      }
    else{
      Inf
      }
  }
  # df.all$interview_date = df.all$interview_date %>% as.Date(format = '%m/%d/%Y')
  df.all <- df.all %>%
    group_by(subjectkey) %>%
    mutate(time.since.baseline = as.numeric(interview_age - custom_min(interview_age))) %>% # Reported as months
    # mutate(time.since.baseline = as.numeric(interview_date - custom_min(interview_date))) %>% # Reported as days
    arrange(subjectkey,interview_age) 
    
  # Fill in some of the data to match info from baseline
  df.all <- df.all %>% 
    group_by(subjectkey) %>% 
    mutate(abcd_site=first(abcd_site),
           rel_family_id=first(rel_family_id),
           mri_info_manufacturer = first(mri_info_manufacturer),
           demo_comb_income_v2 = first(demo_comb_income_v2),
           demo_ethn_v2 = first(demo_ethn_v2),
           demo_sex_v2 = first(demo_sex_v2),
           Race_White = first(Race_White),
           Race_Black = first(Race_Black),
           Race_Native = first(Race_Native),
           Race_PacificIslander = first(Race_PacificIslander),
           Race_Asian = first(Race_Asian),
           Race_Other = first(Race_Other),
           demo_prnt_marital_v2 = first(demo_prnt_marital_v2),
           demo_prnt_ed_v2 = first(demo_prnt_ed_v2),
           demo_prtnr_ed_v2 = first(demo_prtnr_ed_v2))
  
  # Replace the "" entries for education with 777
  df.all <- df.all %>%
    mutate(demo_prnt_ed_v2 = replace(demo_prnt_ed_v2,
                                     is.na(demo_prnt_ed_v2),
                                     777),
           demo_prtnr_ed_v2 = replace(demo_prtnr_ed_v2,
                                      demo_prtnr_ed_v2 == "" | is.na(demo_prtnr_ed_v2),
                                      777))
  # Create highest education variable
  df.all <- df.all %>%
    mutate(demo_prtnr_ed_v2 = na_if(demo_prtnr_ed_v2,777)) %>%
    mutate_at(vars(matches("demo_prnt_ed_v2")),as.numeric) %>%
    mutate_at(vars(matches("demo_prtnr_ed_v2")),as.numeric) %>%
    mutate(demo_ed_highest = max(demo_prnt_ed_v2,demo_prtnr_ed_v2,na.rm = TRUE)) %>%
    mutate_at(vars(matches("demo_ed_highest")),as.numeric)
}

filter_data = function(df.all,outcome = TRUE, pffr = FALSE){
  # outcome - binary flag. Does the input include the clinical outcome?
  # pffr - binary flag. Is this for the PFFR analysis? If not, there's a lot more filter statements involved
  # Remove some rows that meet certain conditions
  df.all <- df.all %>%
    print_filtered_rows(!is.na(lh_bankssts)) %>% # Remove if CT data missing. Verified that other ROIs do not have missing values after this filter statement
    print_filtered_rows(!(fsqc_qc != 1)) %>%
    print_filtered_rows(!is.na(pds)) %>% 
    print_filtered_rows(!(Race_White == 0 &
               Race_Black == 0 &
               Race_Native == 0 &
               Race_PacificIslander == 0 &
               Race_Asian == 0 &
               Race_Other == 0)) %>%
    print_filtered_rows(!(demo_sex_v2 ==3)) %>%
    print_filtered_rows(!(demo_comb_income_v2 == 777 | demo_comb_income_v2 == 999)) %>%
    print_filtered_rows(demo_ethn_v2 %in% c(1,2)) %>%
    print_filtered_rows(!(is.na(mri_info_manufacturer) | mri_info_manufacturer=="")) %>%
    print_filtered_rows(!(demo_prnt_marital_v2 == 777)) %>% 
    print_filtered_rows(!((demo_prnt_ed_v2 == 777 & demo_prtnr_ed_v2 == 777) |
               (demo_prnt_ed_v2 == 777 & demo_prtnr_ed_v2 == ""))) %>%
    print_filtered_rows(!(demo_prnt_ed_v2 == 777 & demo_prtnr_ed_v2 == 999))
  
  if(!pffr){
    df.all <- df.all %>%
      # print_filtered_rows(eventname %in% c("baseline_year_1_arm_1",'2_year_follow_up_y_arm_1')) %>% # Look at baseline and 2-year follow up only
      print_filtered_rows(!is.na(fsqc_qc))
    if(outcome){
      df.all <- df.all %>% # Remove the visits where this QC variable is missing
      group_by(subjectkey) %>%
      print_filtered_rows(n()>1) %>% # Remove subjects with only one observation, i.e., no follow-up data
      print_filtered_rows(!any(is.na(outcome)))
    }
    else{
      df.all <- df.all %>% # Remove the visits where this QC variable is missing
      group_by(subjectkey) %>%
      print_filtered_rows(n()>1) # Remove subjects with only one observation, i.e., no follow-up data
    }
  }
  return(df.all)
}
```

## Utility function for creating forest plots
```{r,echo=FALSE,warning=FALSE,message=FALSE}
# Aidan's Forest Plot
make_forest_plot <- function(tidy_results, log.ors = FALSE, betas = FALSE) {
  
  #if(betas == FALSE & log.ors == TRUE){
  #  tidy_results[,1:3] = log(tidy_results[,1:3])
  #}
  
  n_roi <- tidy_results$roi %>% unique %>% length
  manual_colors <- rep(c("#ffffff00", "#f0f0f090"), 100)[1:n_roi]
  
  p <- ggplot(aes(x = estimate, y = Effect), data = tidy_results)
  
  #if (log.ors == TRUE) {
    #p <- p + geom_rect(aes(xmin = 0, xmax = 10000,
    #          ymin = -Inf, ymax = Inf, fill = roi))
  #} else if (log.ors == FALSE) {
    #p <- p + geom_rect(aes(xmin = -Inf, xmax = Inf,
    #                       ymin = -Inf, ymax = Inf, fill = roi))
  #}
  #p <- p + scale_fill_manual(values = manual_colors, guide = "none")
  p <- p + geom_errorbarh(aes(xmin = lower95ci, xmax = upper95ci))
  p <- p + geom_point(aes(colour = Effect, shape = Effect), color='black',size = 5) 
  
  if (betas == FALSE) {
    
      if (log.ors == TRUE) {
    
      p <- p + geom_vline(aes(xintercept = 1), linetype = 2) + 
        scale_x_log10() +
        coord_cartesian(xlim = c(0.0001, 1000)) + 
        xlab("Log Odds Ratio (95% CI)") 
      p <- p + facet_grid(rows = vars(roi %>% 
                                   factor(levels =
                                            roi)), switch = "y")
      
    } else if (log.ors == FALSE) {
  
      xmax <- max(tidy_results$upper95ci) + 25
      p <- p + xlim(0, xmax) +
        xlab("Odds Ratio (95% CI)")
      p <- p + facet_grid(rows = vars(roi %>% 
                                    factor(levels = roi)), switch = "y")
    }
    
  } else if (betas == TRUE) {
    p <- p + geom_vline(aes(xintercept = 0), linetype = 2) + 
      xlab("Standardized Effects")
    p <- p + facet_grid(rows = vars(roi %>% 
                                    factor(levels = roi)), switch = "y")
  }
  
  #p <- p + facet_grid(rows = vars(roi %>% 
                                    #factor(levels = roi[order(abs(estimate),decreasing = TRUE)])), switch = "y") + 
  p <- p +
    theme_bw() +
    theme(panel.spacing.y = unit(0, "points"), 
          panel.border = element_blank(),
          axis.text.y = element_blank(), 
          axis.ticks.length.y = unit(0, "points"),
          strip.text.y.left = element_text(angle = 0), 
          strip.background.y = element_blank(),
          strip.placement = "outside", 
          axis.line = element_line()
      ) + 
    ylab("Region") + 
    scale_color_brewer(palette="Set1") +
    geom_stripped_rows()
  

  return(p)
}

transform_results <- function(results, 
                              roi_lookup_table =  readxl::read_xlsx("~/Research/ABCD/Puberty/roi_lookup_table.xlsx")) {
  
  tidy_results <- results

  interaction_index <- rownames(tidy_results) %>%
    str_detect("Sex : ") %>%
    which
  tidy_results$Effect <- "Main Effect CT Change"
  tidy_results$Effect[interaction_index] <- "Sex x CT Change Interaction"

  pattern <- rownames(tidy_results) %>%
    str_locate("Change - ")
  start_ids <- pattern[,2]+1
  end_ids <- vector()
  
  for (r in 1:length(rownames(tidy_results))) {
    name <- rownames(tidy_results)[r]
    # odd case
    if (r%%2==1) {
      end_ids <- c(end_ids, nchar(name))
    } else {
      end_ids <- c(end_ids, nchar(name)-1)
    }
  }
  
  tidy_results$roi <- substring(rownames(tidy_results), start_ids, end_ids) 
  
  for (region in tidy_results$roi) {
    region_ind <- which(tidy_results$roi == region)
    region_sub <- subset(roi_lookup_table, computer_name == region)$human_name
    if (length(region_sub) > 0) {
        tidy_results$roi[region_ind] <- region_sub
    }
  }
  
  rownames(tidy_results) <- NULL
  
  colnames(tidy_results)[1] <- "estimate"
  
  return(tidy_results)
}

get_by_sex <- function(models) {
  
  ors_by_sex <- data.frame(matrix(ncol = 4, nrow = 0))
  colnames(ors_by_sex) <- c("Sex", "estimate", "lower95ci", "upper95ci")
  
  library(gmodels)
  
  for (i in 1:length(models)) {
    
    fit <- models[[i]]
    estimated_coefficients <- fit$coefficients
    n_variables <- length(estimated_coefficients)
    ct_change_ind <- which(names(estimated_coefficients) == "roi.change")
    ct_change_interaction_ind <- which(names(estimated_coefficients) == "demo_sex_v22:roi.change") # 2 = female

    contrast_female <- ifelse(1:n_variables %in% c(ct_change_ind, ct_change_interaction_ind), 1, 0)
    estimate_female <- estimable(fit, contrast_female, conf.int = 0.95)
    
    contrast_male <- ifelse(1:n_variables %in% ct_change_ind, 1, 0)
    estimate_male <- estimable(fit, contrast_male, conf.int = 0.95)
    
    ors <- data.frame(matrix(ncol = 4, nrow = 2))
    colnames(ors) <- c("Sex", "estimate", "lower95ci", "upper95ci")
    ors$Sex <- c("Female", "Male")
    ors[1, 2:4] <- exp(estimate_female[c("Estimate", "Lower.CI", "Upper.CI")])
    ors[2, 2:4] <- exp(estimate_male[c("Estimate", "Lower.CI", "Upper.CI")])
    
    ors_by_sex <- ors_by_sex %>% rbind(ors)
      
  }
  
  return(ors_by_sex)
  
}
```
# Aim 1
## Penalized Function-on-function Regression Analysis
We used a modified version of Meng's PFFR analysis. Using the merged data and restricting the analysis to the subjects who will also be in the clinical analysis, we conduct the PFFR analysis. The PFFR analysis loops across the 34 ROIs, and outputs the results for the main effect and interaction for (binarized) sex and PDS. For the revision, this function is now broader. There are four outputs: 1) The "original" PFFR analysis, 2) PFFR+covariates, 3) a "minimum" LME, and 4) LME with covariates. (4) will be the "main" analysis approach, and (2) will be exploratory.
```{r,echo=FALSE}
aim1_analysis = function(merged.data,id=NULL){
  # id - vector of unique identifiers to include in the analysis
  ctrlist<-list()
  ctrlist.covar<-list()
  lmelist<-list()
  lmelist.covar<-list()
  lmelist.std.params = list()
  lmelist.covar.std.params = list()
  lmelist.models = list()
  lmelist.covar.models = list()
  lmelist.id = list()
  lmelist.covar.id = list()
  if(is.null(id)){
    df = merged.data 
  }
  else{
    df = merged.data %>%
      filter(subjectkey %in% id)
  }
  # forloop for 34 ROIs
  for (rid in 1:34){
    roi = names(merged.data)[2+rid]
    
    ## LME
    #lme.formula1 = 'outcome ~ demo_sex_v2*pds + interview_age +
    #                (1|abcd_site/rel_family_id/subjectkey)' %>% as.formula
    #lme.formula2 = 'outcome ~ demo_sex_v2*pds + interview_age + demo_ethn_v2 + 
    #demo_comb_income_v2 + demo_prnt_marital_v2 +demo_ed_highest + 
    #mri_info_manufacturer + Race_White + Race_Black + Race_Native + Race_PacificIslander + Race_Asian + Race_Other +
    #(1|abcd_site/rel_family_id/subjectkey)' %>% as.formula
    lme.results = lmer(outcome ~ demo_sex_v2*pds + interview_age +
                    (1|abcd_site/rel_family_id/subjectkey),
                       data = df %>% 
                         dplyr::rename(outcome = !!roi))
    lme.covar.results = lmer(outcome ~ demo_sex_v2*pds + interview_age + demo_ethn_v2 + 
    demo_comb_income_v2 + demo_prnt_marital_v2 +demo_ed_highest + 
    mri_info_manufacturer + Race_White + Race_Black + Race_Native + Race_PacificIslander + Race_Asian + Race_Other +
    (1|abcd_site/rel_family_id/subjectkey),
                             data = df %>%
                               dplyr::rename(outcome = !!roi))
    
    lmelist.std.params[[rid]] = lme.results %>%
      standardize_parameters() %>% 
      as.data.frame() # Use the effectsize package
    lmelist.covar.std.params[[rid]] = lme.covar.results %>%
      standardize_parameters() %>% 
      as.data.frame() # Use the effectsize package
      
    
    df.wide = df %>% 
        dplyr::select(subjectkey,demo_sex_v2,!!roi,interview_age,pds,
                      demo_ethn_v2,demo_comb_income_v2,demo_prnt_marital_v2,
                      demo_prnt_ed_v2,demo_prtnr_ed_v2,demo_ed_highest,
                      mri_info_manufacturer,Race_White:Race_Other,fsqc_qc,
                      abcd_site,rel_family_id,roi) %>%
        group_by(subjectkey) %>% 
        mutate(visit=1:n()) %>% 
        pivot_wider(names_from = visit, 
                    values_from = c("pds","interview_age",!!roi,fsqc_qc))
    
    sdtct = df[,c('subjectkey','interview_age',roi)]
    #sdtp_sx = df[,c('subjectkey','interview_age','sex','pds')]
    sdtp_sx = df[,c('subjectkey','interview_age','demo_sex_v2','pds')]
    sdtp = df[,c('subjectkey','interview_age','pds')]
    
    colnames(sdtct)<-colnames(sdtp)<-c('.id','.index','.value')
    fct<-refund:::irreg2mat(sdtct);dim(fct)
    fp<-refund:::irreg2mat(sdtp);dim(fp)
    
    
    #dpsx1<-as.numeric(factor(sdtp_sx1[!duplicated(sdtp_sx1$subjectkey),'sex'],levels = c('M','F'),labels = 1:2))
    
    dpsx =(df %>% group_by(subjectkey) %>% 
             filter(row_number() == 1))$demo_sex_v2 %>% # Get the first row per subject, so that we get sex at baseline
      as.numeric()
    dpsx=dpsx-1
    fpsx<-fp #inter term
    for (i in 1:length(dpsx)){
      fpsx[i,] <-fp[i,]*dpsx[i]
    }
    
    df.wide$dpsx = dpsx
    df.wide$fct = fct
    df.wide$fp = fp
    df.wide$fpsx = fpsx
    
    res2<-pffr(fct~dpsx+fp+fpsx,
               yind=attr(fct,'index'),
               data = df.wide)
    sres2=summary(res2)
    res3<-pffr(fct~dpsx+fp+fpsx + 
                 c(demo_ethn_v2) + c(demo_comb_income_v2) + c(demo_prnt_marital_v2) + 
                 c(demo_ed_highest) + c(mri_info_manufacturer) +
                 c(Race_White) + c(Race_Black) + c(Race_Native) + c(Race_PacificIslander) + 
                 c(Race_Asian) + c(Race_Other), 
               yind=attr(fct,'index'),
               data=df.wide)
    sres3=summary(res3)
    
    cres2=coef(res2)
    argv<-cres2$smterms$`fp(yindex)`$coef$yindex.vec
    effmb=cres2$smterms$`fp(yindex)`$coef$value+as.numeric(names(table(dpsx)))[1]*cres2$smterms$`fpsx(yindex)`$coef$value
    effmg=cres2$smterms$`fp(yindex)`$coef$value+as.numeric(names(table(dpsx)))[2]*cres2$smterms$`fpsx(yindex)`$coef$value
    
    ctrlist[[rid]]<-list(argv=argv,effmb=effmb,effmg=effmg,
                         b2=cres2$smterms$`fp(yindex)`$coef$value,
                         b3=cres2$smterms$`fpsx(yindex)`$coef$value,
                         sp=sres2$s.table,
                         id = df$subjectkey %>% unique())
    # dpsx is main effect for sex
    # fp is main effect for puberty score
    # fpsx is puberty score and sex interaction
    
    # Should look at fp and fpsx pvalues
    cres3=coef(res3)
    argv<-cres3$smterms$`fp(yindex)`$coef$yindex.vec
    effmb=cres3$smterms$`fp(yindex)`$coef$value+as.numeric(names(table(dpsx)))[1]*cres3$smterms$`fpsx(yindex)`$coef$value
    effmg=cres3$smterms$`fp(yindex)`$coef$value+as.numeric(names(table(dpsx)))[2]*cres3$smterms$`fpsx(yindex)`$coef$value
    
    ctrlist.covar[[rid]]<-list(argv=argv,effmb=effmb,effmg=effmg,
                         b2=cres3$smterms$`fp(yindex)`$coef$value,
                         b3=cres3$smterms$`fpsx(yindex)`$coef$value,
                         sp=sres3$s.table)
                         #id = df.wide$subjectkey %>% unique())
    
    lmelist[[rid]] = lme.results %>% summary() %>% coefficients()
    lmelist.covar[[rid]] = lme.covar.results %>% summary() %>% coefficients()
    
    lmelist.models[[rid]] = lme.results
    lmelist.covar.models[[rid]] = lme.covar.results
    
    lmelist.id[[rid]] = lme.results@frame$subjectkey
    lmelist.covar.id[[rid]] = lme.covar.results@frame$subjectkey
  }
  return(list(ctrlist = ctrlist,
              ctrlist.covar = ctrlist.covar,
              lme.results = lmelist,
              lme.covar.results = lmelist.covar,
              lmelist.std.params = lmelist.std.params,
              lmelist.covar.std.params = lmelist.covar.std.params,
              lmelist.models = lmelist.models,
              lmelist.covar.models = lmelist.covar.models,
              lmelist.id = lmelist.id,
              lmelist.covar.id = lmelist.covar.id))
}

```

## Identifying ROIs
Using the above code for PFFR analysis, we identify the ROIs with significant effects. The point is to restrict our analyses only to certain ROIs.
```{r,echo=FALSE,message=FALSE, results = 'hide'}
aim1.results = aim1_analysis(merged.data = merge_data(df.outcome = NULL) %>% filter_data(outcome=FALSE,pffr=TRUE),
                             id = NULL) # id = NULL means use all available data

get_pvals = function(labels,results,nugget = 0,log=FALSE,lme = FALSE,sig.method='bonferroni'){
  # Meng's code chunk turned into a function
  # Modified for generic p-value adjustment
  res.datfram.pval<-data.frame(label=labels,p2=NA,p3=NA,stat2=NA,stat3=NA)
  
  pvals.p = rep(NA,nrow(res.datfram.pval))
  pvals.psx = rep(NA,nrow(res.datfram.pval))
  stat.p = rep(NA,nrow(res.datfram.pval))
  stat.psx = rep(NA,nrow(res.datfram.pval))
  for(j in 1:nrow(res.datfram.pval)){
    if(lme){
      pvals.p[j] = (results[[j]] %>% 
                   as.data.frame() %>%
                   filter(rownames(results[[j]])=='pds'))[5]
      pvals.psx[j] = (results[[j]] %>% 
                     as.data.frame() %>%
                     filter(rownames(results[[j]])=='demo_sex_v22:pds'))[5] 
      stat.p[j] = (results[[j]] %>% 
                   as.data.frame() %>%
                   filter(rownames(results[[j]])=='pds'))[4]
      stat.psx[j] = (results[[j]] %>% 
                     as.data.frame() %>%
                     filter(rownames(results[[j]])=='demo_sex_v22:pds'))[4] 
    }
    else{
      pvals.p[j] = results[[j]]$sp[3,4]
      pvals.psx[j] = results[[j]]$sp[4,4]
      stat.p[j] = results[[j]]$sp[3,3]
      stat.psx[j] = results[[j]]$sp[4,3]
    }
  }
  # Adjust the p-values
  pvals.p = p.adjust(pvals.p,method=sig.method)
  pvals.psx = p.adjust(pvals.psx,method=sig.method)
  
  for(j in 1:nrow(res.datfram.pval)){
    if(log){
      res.datfram.pval$p2[j]=-log10(pvals.p[j]+nugget)
      res.datfram.pval$p3[j]=-log10(pvals.psx[j] + nugget) 
    }
    else{
      res.datfram.pval$p2[j]=pvals.p[j]
      res.datfram.pval$p3[j]=pvals.psx[j]
    }
    res.datfram.pval$stat2[j] = stat.p[j]
    res.datfram.pval$stat3[j] = stat.psx[j]
  }
  return(res.datfram.pval)
}

res.datfram.pval = get_pvals(atlas_data$label[1:34],aim1.results$ctrlist)
cb3 = res.datfram.pval%>%filter(p3<.05) # This is the interaction effect between puberty and binarized sex
# cb2 = res.datfram.pval%>%filter(p2<.05); # This is the main effect of puberty score
# cb23<-res.datfram.pval%>%filter(p3<.05 & p2<.05); # This is both main and interaction effects
labels = cb3$label

res.datfram.pval.covar = get_pvals(atlas_data$label[1:34],aim1.results$ctrlist.covar)
cb3.covar = res.datfram.pval.covar%>%filter(p3<.05) # This is the interaction effect between puberty and binarized sex
cb2.covar = res.datfram.pval.covar%>%filter(p2<.05); # This is the main effect of puberty score
# cb23.covar<-res.datfram.pval.covar%>%filter(p3<.05 & p2<.05); # This is both main and interaction effects

res.datfram.pval.lme = get_pvals(atlas_data$label[1:34],aim1.results$lme.results,lme = TRUE)
cb3.lme = res.datfram.pval.lme%>%filter(p3<.05) # This is the interaction effect between puberty and binarized sex
# cb2.lme = res.datfram.pval.lme%>%filter(p2<.05); # This is the main effect of puberty score
# cb23.lme<-res.datfram.pval.lme%>%filter(p3<.05 & p2<.05); # This is both main and interaction effects

res.datfram.pval.lme.covar = get_pvals(atlas_data$label[1:34],aim1.results$lme.covar.results,lme = TRUE)
cb3.lme.covar = res.datfram.pval.lme.covar%>%filter(p3<.05) # This is the interaction effect between puberty and binarized sex
cb2.lme.covar = res.datfram.pval.lme.covar%>%filter(p2<.05); # This is the main effect of puberty score
cb23.lme.covar<-res.datfram.pval.lme.covar%>%filter(p3<.05 & p2<.05); # This is both main and interaction effects


```
### Getting table of results
```{r}

get_table_results = function(results,lme=FALSE){
  if(lme){
    tstat.sex = rep(NA,length(results))
    tstat.pds = rep(NA,length(results))
    tstat.interaction = rep(NA,length(results))
    pval.sex = rep(NA,length(results))
    pval.pds = rep(NA,length(results))
    pval.interaction = rep(NA,length(results))
    for(j in 1:length(results)){
      results.df = as.data.frame(results[[j]])
      tstat.sex[j] = (results.df %>% dplyr::filter(rownames(results.df) %in% c('demo_sex_v22')))['t value'] %>% as.numeric()
      tstat.pds[j] = (results.df %>% dplyr::filter(rownames(results.df) %in% c('pds')))['t value'] %>% as.numeric()
      tstat.interaction[j] = (results.df %>% dplyr::filter(rownames(results.df) %in% c('demo_sex_v22:pds')))['t value'] %>% as.numeric()
      pval.sex[j] = (results.df %>% dplyr::filter(rownames(results.df) %in% c('demo_sex_v22')))['Pr(>|t|)'] %>% as.numeric()
      pval.pds[j] = (results.df %>% dplyr::filter(rownames(results.df) %in% c('pds')))['Pr(>|t|)'] %>% as.numeric()
      pval.interaction[j] = (results.df %>% dplyr::filter(rownames(results.df) %in% c('demo_sex_v22:pds')))['Pr(>|t|)'] %>% as.numeric()
    } 

    df.tab = data.frame(roi =atlas_data$label[1:34],
                        tstat.sex = tstat.sex,
                        pval.sex = pval.sex %>% p.adjust(method='bonferroni'),
                        tstat.pds = tstat.pds,
                        pval.pds = pval.pds %>% p.adjust(method='bonferroni'),
                        tstat.interaction = tstat.interaction,
                        pval.interaction = pval.interaction %>%
                          p.adjust(method='bonferroni'))
    df.tab$pval.sex <- df.tab$pval.sex %>%
        format.pval(eps = .001, digits = 2)
      df.tab$pval.pds <- df.tab$pval.pds %>%
        format.pval(eps = .001, digits = 2)
      df.tab$pval.interaction <- df.tab$pval.interaction %>%
        format.pval(eps = .001, digits = 2)
      return(df.tab %>% kbl(digits = 3) %>%
        kable_paper() %>%
        add_header_above(c(" ", "Main effect - Sex" = 2, "Main effect - PDS" = 2, "Sex x PDS interaction" = 2)))
    }
  else{
      Fstat.sex = rep(NA,length(results))
      Fstat.pds = rep(NA,length(results))
      Fstat.interaction = rep(NA,length(results))
      pval.sex = rep(NA,length(results))
      pval.pds = rep(NA,length(results))
      pval.interaction = rep(NA,length(results))
      for(j in 1:length(results)){
        Fstat.sex[j] = results[[j]]$sp[2,3]
        Fstat.pds[j] = results[[j]]$sp[3,3]
        Fstat.interaction[j] = results[[j]]$sp[4,3]
        pval.sex[j] = results[[j]]$sp[2,4]
        pval.pds[j] = results[[j]]$sp[3,4]
        pval.interaction[j] = results[[j]]$sp[4,4]
      }
      df.tab = data.frame(roi =atlas_data$label[1:34],
                          Fstat.sex = Fstat.sex,
                          pval.sex = pval.sex %>% p.adjust(method='bonferroni'),
                          Fstat.pds = Fstat.pds,
                          pval.pds = pval.pds %>% p.adjust(method='bonferroni'),
                          Fstat.interaction = Fstat.interaction,
                            pval.interaction = pval.interaction %>%
                            p.adjust(method='bonferroni'))
      df.tab$pval.sex <- df.tab$pval.sex %>%
          format.pval(eps = .001, digits = 2)
        df.tab$pval.pds <- df.tab$pval.pds %>%
          format.pval(eps = .001, digits = 2)
        df.tab$pval.interaction <- df.tab$pval.interaction %>%
          format.pval(eps = .001, digits = 2)
        return(df.tab %>% kbl(digits = 3) %>%
          kable_paper() %>%
          add_header_above(c(" ", "Main effect - Sex" = 2, "Main effect - PDS" = 2, "Sex x PDS interaction" = 2)))
  }
}

#get_table_results(aim1.results$ctrlist,lme=FALSE)
get_table_results(aim1.results$ctrlist.covar,lme=FALSE)
# get_table_results(aim1.results$lme.results,lme=TRUE)
get_table_results(aim1.results$lme.covar.results,lme=TRUE)
```
### Getting Aim 1 LMER unstandardized coefficients and p-values
The following results are for the LMER with covariates.
```{r aim1_lmer, results='asis'}
tables_aim1_lmer = function(results, label){
  for(j in 1:length(results)){
    results[[j]] %>% 
      summary() %>% 
      coefficients() %>%
      as.data.frame() %>%
      mutate(term = results[[j]] %>% 
               summary() %>% 
               coefficients() %>% 
               rownames(),
             .before = Estimate) %>%
      dplyr::select(-4) %>%
      dust() %>%
      sprinkle(col=2:4,round=3) %>%
      sprinkle(col=5,fn=quote(pvalString(value))) %>%
      sprinkle_colnames("Term",
                        "Estimate",
                        "SE",
                        "t-statitic",
                        "p-value") %>%
      kable(caption = paste0(label[j], 
                             " Conditional R^2 = ", 
                             ((results[[j]] %>% r2_nakagawa())[1] %>% # Conditional R2
                                as.numeric() %>% 
                                round(digits = 3)))) %>%
      kable_styling() %>%
      print()
    cat('\n\n<!-- -->\n\n')
    
    } 
}
tables_aim1_lmer(aim1.results$lmelist.covar.models, atlas_data$label[1:34])

```

### Getting Aim 1 LMER standardized coefficients and CIs
Next, we report the same as in the previous set of tables, but this time present the standardized regression coefficients and their confidence intervals.
```{r std_coef, results = 'asis'}
print('Standardized coefficients and CIs for the LMER with covariates:')
for(j in 1:length(aim1.results$lmelist.covar.std.params)){
  aim1.results$lmelist.covar.std.params[[j]] %>% 
    dplyr::select(Parameter,Std_Coefficient,CI_low,CI_high) %>%
    kbl(digits=3,caption = paste(atlas_data$label[j])) %>%
    kable_paper() %>%
    print()
  cat('\n\n<!-- -->\n\n')
}
```

# Aim 1a   plots
```{r,warning=FALSE}
# Taken from Aidan's code
results <- aim1.results$lme.covar.results
labels <- atlas_data$label[1:34]
df.estimates = data.frame(estimate=NULL, conf.low = NULL, conf.high = NULL)
# models added to aim1.analysis function
for (i in 1:length(labels)) {
  roi.name = labels[i] %>% substring(4)
  lme.formula2 = paste(labels[i],'~ demo_sex_v2*pds + interview_age + 
    demo_ethn_v2 + demo_comb_income_v2 + demo_prnt_marital_v2 +
    demo_ed_highest + mri_info_manufacturer + Race_White + Race_Black + 
    Race_Native + Race_PacificIslander + Race_Asian + Race_Other +
    (1|abcd_site/rel_family_id/subjectkey)')
  std.params = effectsize::standardize_parameters(aim1.results$lmelist.covar.models[[i]]) %>% as.data.frame()
  df.est = std.params %>% dplyr::select(Parameter, Std_Coefficient, CI_low, CI_high)
  df.est = df.est %>%
    filter(Parameter %in% c('pds','demo_sex_v22:pds')) %>%
    dplyr::select(Std_Coefficient,CI_low,CI_high)
  rownames(df.est) = c(paste0("Change - ", roi.name),
                     paste0("Sex : ","(Change - ", roi.name,")"))
  df.estimates = df.estimates %>% rbind(df.est)
}
tidy_aim_1 <- transform_results(df.estimates) %>%
  rename(lower95ci = CI_low) %>%
  rename(upper95ci = CI_high) %>%
  filter(Effect == "Sex x CT Change Interaction")
p <- make_forest_plot(tidy_aim_1 %>%
                        slice(order(tidy_aim_1$estimate,decreasing=FALSE)), 
                      betas = TRUE)
p
roi.order = (tidy_aim_1 %>%
                        slice(order(tidy_aim_1$estimate,decreasing=FALSE)))$roi

tidy_aim_1 <- transform_results(df.estimates) %>%
  rename(lower95ci = CI_low) %>%
  rename(upper95ci = CI_high) %>%
  filter(Effect == "Main Effect CT Change")
p <- make_forest_plot(tidy_aim_1 %>%
                        slice(order(tidy_aim_1$estimate,decreasing=FALSE)), 
                      betas = TRUE)
p
```

## Creating brain figures
This code chunk is revised straight from Meng's old code on creating the figures. A lot of the edits were to make this more functional so that we can pass results from revisions to the model (e.g., including covariates). The figures here are from the PFFR with covariates
```{r, echo=FALSE, message = FALSE,warning=FALSE}
make.brain = function(ctrlist,sexid,sig.only=FALSE,sig.method='bonferroni',interaction = TRUE){
  atlas_data <- read_atlas_files (
  subjects_dir = "/Applications/freesurfer/subjects/",
  atlas="aparc.stats")
  
  agetb<-round(seq(1,100,,5))
  res.datfram.pval = get_pvals(atlas_data$label[1:34],ctrlist,nugget = 0,log=FALSE,lme=FALSE,
                               sig.method=sig.method)

  res.datfram<-data_frame(label=atlas_data$label[1:34])
  for (i in 1:length(agetb)) for (j in 1:nrow(res.datfram)){
    if(sig.only){
      pvalue = NA
      if(interaction==TRUE){pvalue = res.datfram.pval$p3[j]}else{pvalue = res.datfram.pval$p2[j]}
      if(pvalue < 0.05){
        if(sexid =='male'){
          res.datfram[j,1+i]=ctrlist[[j]]$effmb[agetb[i]]
        }
        if(sexid =='female'){
          res.datfram[j,1+i]=ctrlist[[j]]$effmg[agetb[i]]
        }
      }
      else{
        res.datfram[j,1+i]= NA
      }
    }
    else{
      if(sexid =='male'){
          res.datfram[j,1+i]=ctrlist[[j]]$effmb[agetb[i]]
        }
        if(sexid =='female'){
          res.datfram[j,1+i]=ctrlist[[j]]$effmg[agetb[i]]
        }
    }
  }
  colnames(res.datfram)[2:(1+length(agetb))]=paste0('age',1:length(agetb))
  
  #########visualization
  minrg<--0.04#min(unlist(res.datfram[,2:(1+length(agetb))]),na.rm = T);minrg
  # maxrg<-0.0027#max(unlist(res.datfram[,2:(1+length(agetb))]),na.rm = T);maxrg
  maxrg<-0.0048#max(unlist(res.datfram[,2:(1+length(agetb))]),na.rm = T);maxrg
  rng=c(minrg,maxrg)#range(c(a.dat$age1, a.dat$age2,a.dat$age3),na.rm = T)
  brk=round(seq(minrg,maxrg,,5),3)
  
  fig.lateral = list()
  for (i in 1:(length(agetb)-1)){
    a.dat<-atlas_data %>%
      filter(subject == "bert")%>% 
      left_join(res.datfram %>%
                  dplyr::select(label,paste0('age',i)) %>%
                  dplyr::rename(age = paste0('age',i)),
                by='label') 
  
    fig.lateral[[i]] = a.dat%>%
      ggseg(mapping = aes(fill = age),
            hemisphere="left",
            view = "lateral") +
      labs(title ='',# paste0('age',round(ctrlist[[1]]$argv[agetb[i]]/12,2)),
           fill = "slope") +
      scale_fill_gradient2(low="#FF0080", mid="#FF8C00", high="#40E0D0",#low="#f7797d", mid="#FBD786", high="#C6FFDD",
                           midpoint=mean(rng),    
                           breaks=brk,
                           limits=c((rng[1]), (rng[2]))) +
      guides(fill ='none')+#guide_colourbar(barheight= 5))+ 
      theme_void()
    }
  i=5
  a.dat<-atlas_data %>%
      filter(subject == "bert")%>% 
      left_join(res.datfram %>%
                  dplyr::select(label,paste0('age',i)) %>%
                  dplyr::rename(age = paste0('age',i)),
                by='label') 
  fig.lateral[[i]] = a.dat%>%
    ggseg(mapping = aes(fill = age),
          hemisphere="left",
          view = "lateral") +
    labs(title = '',#paste0('age',round(ctrlist[[1]]$argv[agetb[i]]/12,2)),
         fill = "slope") +
    scale_fill_gradient2(low="#FF0080", mid="#FF8C00", high="#40E0D0",#low="#f7797d", mid="#FBD786", high="#C6FFDD",
                         midpoint=mean(rng),    
                         breaks=brk,
                         limits=c((rng[1]), (rng[2]))) +
    guides(fill =guide_colourbar(barheight= 5))+ 
    theme_void()
  
  fig.medial = list()
  for (i in 1:(length(agetb)-1)){
    a.dat<-atlas_data %>%
      filter(subject == "bert")%>% 
      left_join(res.datfram %>%
                  dplyr::select(label,paste0('age',i)) %>%
                  dplyr::rename(age = paste0('age',i)),
                by='label') 
    fig.medial[[i]] = a.dat%>%
      ggseg(mapping = aes(fill = age),
            hemisphere="left",
            view = "medial") +
      labs(title = '',#paste0('age',round(ctrlist[[1]]$argv[agetb[i]]/12,2)),
           fill = "slope") +
      scale_fill_gradient2(low="#FF0080", mid="#FF8C00", high="#40E0D0",#low="#f7797d", mid="#FBD786", high="#C6FFDD",
                           midpoint=mean(rng),    
                           breaks=brk,
                           limits=c((rng[1]), (rng[2]))) +
      guides(fill = 'none')+#guide_colourbar(barheight= 5))+ 
      theme_void()
  }
  i=5
  a.dat<-atlas_data %>%
      filter(subject == "bert")%>% 
      left_join(res.datfram %>%
                  dplyr::select(label,paste0('age',i)) %>%
                  dplyr::rename(age = paste0('age',i)),
                by='label') 
  fig.medial[[i]] = a.dat%>%
    ggseg(mapping = aes(fill = age),
          hemisphere="left",
          view = "medial") +
    labs(title = '',fill = "slope") +
    scale_fill_gradient2(low="#FF0080", mid="#FF8C00", high="#40E0D0",
                         midpoint=mean(rng),    
                         breaks=brk,
                         limits=c((rng[1]), (rng[2]))) +
    guides(fill = 'none')+ 
    theme_void()
  
  return(list(lateral = fig.lateral,
              medial = fig.medial))
}

make.brain.pvals = function(results,atlas_data,lme=FALSE,
                            lower=-log10(0.05),mid=-log10(0.01),upper=20.221,
                            pval=TRUE,sig.only = FALSE,sig.method='bonferroni'){
  res.datfram.pval = get_pvals(atlas_data$label[1:34],results,nugget = 1e-16,log=TRUE,
                               lme=lme,sig.method = sig.method)
  res.datfram.pval$stat2 = res.datfram.pval$stat2 %>% unlist
  res.datfram.pval$stat3 = res.datfram.pval$stat3 %>% unlist
  if(sig.only){
    res.datfram.pval$stat2[which(res.datfram.pval$p2 < -log10(.05))] = NA
    res.datfram.pval$stat3[which(res.datfram.pval$p3 < -log10(.05))] = NA
    res.datfram.pval$p2[which(res.datfram.pval$p2 < -log10(.05))] = NA
    res.datfram.pval$p3[which(res.datfram.pval$p3 < -log10(.05))] = NA
  }
  p.dat<-atlas_data %>%
    filter(subject == "bert") %>%
    left_join(res.datfram.pval,by='label') 
  
  if(pval){
    minrg<- min(unlist(res.datfram.pval$p2))
    maxrg<-max(unlist(res.datfram.pval$p2))  
  }
  else{
    minrg<- min(res.datfram.pval$stat2 %>% unlist, 
                res.datfram.pval$stat3 %>% unlist)
    maxrg<-max(res.datfram.pval$stat2 %>% unlist, 
                res.datfram.pval$stat3 %>% unlist)
  }
  
  rng=c(minrg,maxrg)#range(c(a.dat$age1, a.dat$age2,a.dat$age3),na.rm = T)
  brk=round(seq((lower),upper,,6),3)
  
  if(pval){
    p2.fig=p.dat%>%
      ggseg(mapping = aes(fill = p2),
            hemisphere="left") +
      labs(title = 'Sex-adjusted PDS effect',
           fill = "-log10(pval)") +
      scale_fill_gradient2(low="#f7797d", mid="#FBD786", high="#24FE41",
                          midpoint = mid,
                           breaks=brk,
                           limits=c((lower),upper)) +
      guides(fill ='none')+
      theme_void();
    
    p3.fig=p.dat%>%
      ggseg(mapping = aes(fill = p3),
            hemisphere="left") +
      labs(title = 'Sex-different effect',
           fill = "-log10(pval)") +
      scale_fill_gradient2(low="#f7797d", mid="#FBD786", high="#24FE41",
                           midpoint = mid,
                           breaks=brk,
                           limits=c((lower),upper)) +
      guides(fill =guide_colourbar(barheight= 5))+ 
      theme_void();
  }
  else{
    p2.fig=p.dat%>%
      ggseg(mapping = aes(fill = stat2),
            hemisphere="left") +
      labs(title = 'Sex-adjusted PDS effect',
           fill = "slope") +
      scale_fill_gradient2(low="#f7797d", mid="#FBD786", high="#24FE41",
                          midpoint = mid,
                           breaks=brk,
                           limits=c((lower),upper)) +
      guides(fill ='none')+
      theme_void();
    
    p3.fig=p.dat%>%
      ggseg(mapping = aes(fill = stat3),
            hemisphere="left") +
      labs(title = 'Sex-different effect',
           fill = "slope") +
      scale_fill_gradient2(low="#f7797d", mid="#FBD786", high="#24FE41",
                           midpoint = mid,
                           breaks=brk,
                           limits=c((lower),upper)) +
      guides(fill =guide_colourbar(barheight= 5))+ 
      theme_void();
  }
  #pdf('multi_region_pval23_nowholecontrol.pdf',width = 6,height = 6)
  return(p3.fig/p2.fig)
  #dev.off()
}

make.line.plots = function(ctrlist,atlas_data,labels){
  res.datfram.pval = get_pvals(atlas_data$label[1:34],ctrlist,nugget = 1e-16,log=TRUE,lme=FALSE)
  # Prep work to store all data values in a data frame, before passing on to ggplot
  i=which(res.datfram.pval$label==labels[1]);
  plot.df = data.frame(Age = rep(ctrlist[[i]]$argv/12,2),
                       effect = c(ctrlist[[i]]$b2+ctrlist[[i]]$b3,
                              ctrlist[[i]]$b2))
  if(length(labels) > 1){
    for(j in 2:length(labels)){
      i=which(res.datfram.pval$label==labels[j]);
      plot.df = rbind(plot.df,
                      data.frame(Age = rep(ctrlist[[1]]$argv/12,2),
                                 effect = c(ctrlist[[i]]$b2+ctrlist[[i]]$b3,
                                   ctrlist[[i]]$b2)))
    }
  }
  plot.df = cbind(plot.df,
                  rep(rep(c("Female","Male"),each=length(ctrlist[[1]]$argv)),length(labels)),
                  rep(sapply(labels,function(x){strsplit(x,'_')[[1]][2]}),each=2*length(ctrlist[[1]]$argv)))
  names(plot.df)[3:4] = c("Sex","labels")
  
  line.plots = ggplot(data = plot.df,
                      aes(x=Age, y = effect,group = Sex)) + 
    geom_line(aes(linetype = Sex)) + 
    ylab("PD Effect on CT") + 
    xlab("Interview Age (year)") +
    facet_wrap(~labels, nrow = 3)
  return(list(line.plots = line.plots,
              plot.df = plot.df))
}

make.brain.figures = function(ctrlist,atlas_data,labels,
                              sig.only=FALSE,sig.method='bonferroni',interaction=TRUE){
  fig.male = make.brain(ctrlist,'male',
                        sig.only=sig.only,sig.method=sig.method,interaction=interaction)
  fig.female = make.brain(ctrlist,'female',
                          sig.only=sig.only,sig.method=sig.method,interaction=interaction)
  
  fig1 = (fig.male$lateral[[1]] | fig.male$lateral[[2]] | fig.male$lateral[[3]] | fig.male$lateral[[4]] | fig.male$lateral[[5]] ) / (fig.male$medial[[1]] | fig.male$medial[[2]] | fig.male$medial[[3]] | fig.male$medial[[4]] | fig.male$medial[[5]] ) /
  (fig.female$lateral[[1]] | fig.female$lateral[[2]] | fig.female$lateral[[3]] | fig.female$lateral[[4]] | fig.female$lateral[[5]] ) / (fig.female$medial[[1]] | fig.female$medial[[2]] | fig.female$medial[[3]] | fig.female$medial[[4]] | fig.female$medial[[5]] )
  
  fig2 = make.brain.pvals(ctrlist,atlas_data,lme=FALSE,
                          pval = TRUE,sig.only=sig.only,sig.method=sig.method)
  
  line.plots.dat = make.line.plots(ctrlist,atlas_data,labels)
  
  return(list(fig1 = fig1,
              fig2 = fig2,
              line.plots = line.plots.dat$line.plots,
              line.plots.df = line.plots.dat$plot.df))
}

make.brain.df = function(df,atlas_data,title = '',
                            lower=-log10(0.05),mid=-log10(0.01),upper=20.221){
  
  rng=c(min(df$val),max(df$val))
  brk=round(seq((lower),upper,,6),3)
  
  fig=df%>%
    ggseg(mapping = aes(fill = val),
          hemisphere="left") +
    labs(title = title,
         fill = "slope") +
    scale_fill_gradient2(low="#f7797d", mid="#FBD786", high="#24FE41",
                        midpoint = mid,
                         breaks=brk,
                         limits=c((lower),upper)) +
    guides(fill =guide_colourbar(barheight= 5))+
    theme_void();
    
  return(fig)
}


#figs.pffr = make.brain.figures(aim1.results$ctrlist,
#                               labels = cb3$label)
pvals = res.datfram.pval.lme.covar = get_pvals(atlas_data$label[1:34],
                                               aim1.results$lme.covar.results,
                                               lme = TRUE)$p3
lme.df = data.frame(label = atlas_data$label[1:34],
                    val = rep(NA,34))
for(i in 1:nrow(lme.df)){
  if(pvals[i] < .05){
    lme.df$val[i] = aim1.results$lme.covar.results[[i]]['pds','Estimate']
  }
}
make.brain.df(lme.df,atlas_data,lower=-.01,mid=0,upper=.01,title = 'Male')

lme.df = data.frame(label = atlas_data$label[1:34],
                    val = rep(NA,34))
for(i in 1:nrow(lme.df)){
  if(pvals[i] < .05){
    lme.df$val[i] = aim1.results$lme.covar.results[[i]]['pds','Estimate'] + 
      aim1.results$lme.covar.results[[i]]['demo_sex_v22:pds','Estimate']
  } 
}
make.brain.df(lme.df,atlas_data,lower=-.01,mid=0,upper=.01,title = 'Female')

## standardized effects
#lme.df = data.frame(label = atlas_data$label[1:34],
#                    val = rep(NA,34))
#for(i in 1:nrow(lme.df)){
#  if(pvals[i] < .05){
#    lme.df$val[i] = (aim1.results$lmelist.covar.std.params[[i]] %>% 
##      filter(Parameter == 'pds'))$Std_Coefficient
  #} 
#}
#make.brain.df(lme.df,atlas_data,lower=-.1,mid=0,upper=.1,title = 'Main Effect, PDS')

#lme.df = data.frame(label = atlas_data$label[1:34],
 #                   val = rep(NA,34))
#for(i in 1:nrow(lme.df)){
#  if(pvals[i] < .05){
#    lme.df$val[i] = (aim1.results$lmelist.covar.std.params[[i]] %>% 
#      filter(Parameter == 'demo_sex_v22:pds'))$Std_Coefficient
#  } 
#}
#make.brain.df(lme.df,atlas_data,lower=-.1,mid=0,upper=.1,title = 'Interaction Effect')

# Sanity check plot
#figs.pffr.covar$line.plots$data %>%
#  mutate(age.floor = floor(Age)) %>%
#  group_by(age.floor,Sex,labels) %>%
#  summarize(mean_effect = mean(effect)) %>%
#  rename(Age = age.floor) %>%
#  ggplot(aes(Age,mean_effect,group=Sex,color = Sex)) +
#  geom_line() +
 # geom_point() +
#  facet_grid(~labels)
```
Here are the results from the PFFR with covariates, first with Bonferroni correction and the next set with FDR correction.
```{r,echo=FALSE,message = FALSE,warning=FALSE}
figs.pffr.covar = make.brain.figures(ctrlist = aim1.results$ctrlist.covar,
                                     atlas_data = atlas_data,
                                     labels = cb3.covar$label,
                                     sig.only = TRUE,interaction=TRUE)
figs.pffr.covar$fig1
figs.pffr.covar$fig2
figs.pffr.covar$line.plots

figs.pffr.covar.main = make.brain.figures(ctrlist = aim1.results$ctrlist.covar,
                                      atlas_data = atlas_data,
                                      labels = cb2.covar$label,
                                      sig.only = TRUE,interaction=FALSE)

write.csv(figs.pffr.covar$line.plots$data %>%
  mutate(age.floor = floor(Age)) %>%
  group_by(age.floor,Sex,labels) %>%
  summarize(mean_effect = mean(effect)) %>%
  rename(Age = age.floor),
  row.names = FALSE,
  file = '~/Research/ABCD/Puberty/Aim1_effects.csv')

figs.pffr.covar = make.brain.figures(ctrlist = aim1.results$ctrlist.covar,
                                     atlas_data = atlas_data,
                                     labels = cb3.covar$label,
                                     sig.only = TRUE,
                                     sig.method='fdr')
figs.pffr.covar$fig1
figs.pffr.covar$fig2
figs.pffr.covar$line.plots

```

Here are the results from the LMER with covariates, but the p-value map only.
```{r, echo=FALSE, message = FALSE,warning=FALSE}
figs.lmer = make.brain.pvals(results = aim1.results$lme.covar.results,
                             atlas_data = atlas_data,
                             lme=TRUE,pval=FALSE)
figs.lmer
```

# Aim 2
## The clinical outcomes
We load the clinical outcomes. The ones we include in our analyses are from the KSADS and CBCL spreadsheets.
```{r,echo=FALSE}
ksad501<-read.csv('~/Box/ABCD STUDY/ABCDStudy 4.0 Release/Raw data files/abcd_ksad501.txt',header=T, sep='\t')
ksad501 <- ksad501[-1,]

outcome.vars = c("ksads_23_946_t","ksads_23_947_t","ksads_23_948_t","ksads_23_949_t","ksads_23_950_t",
               "ksads_23_957_t","ksads_23_958_t","ksads_23_959_t","ksads_23_960_t","ksads_23_961_t") # SI CE
df.outcome.ksads <-ksad501 %>% 
  dplyr::select(subjectkey,interview_age,sex,
                eventname,
                all_of(outcome.vars)) %>%
  arrange(subjectkey,interview_age) 
df.outcome.ksads$interview_age <- as.numeric(df.outcome.ksads$interview_age)
df.outcome.ksads$outcome <- df.outcome.ksads %>% 
  dplyr::select(all_of(outcome.vars)) %>%
  mutate_all(as.numeric) %>%
  rowSums()
df.outcome.ksads$outcome <- ifelse(df.outcome.ksads$outcome >= 1, 1, 0)

get_cbcl = function(fn,raw=TRUE){
  cbcl <-read.csv(fn,header=T, sep='\t')
  cbcl <- cbcl[-1,]
  if(raw){
  df.outcome.cbcl<-cbcl %>% 
    dplyr::select(subjectkey,interview_age,sex,
                  eventname,
                  cbcl_scr_syn_internal_r) %>%
    arrange(subjectkey,interview_age) 
  df.outcome.cbcl <- df.outcome.cbcl %>% 
    dplyr::rename(outcome = cbcl_scr_syn_internal_r)
  }
  else{
    df.outcome.cbcl<-cbcl %>% 
    dplyr::select(subjectkey,interview_age,sex,
                  cbcl_scr_syn_internal_t) %>%
    arrange(subjectkey,interview_age) 
    df.outcome.cbcl <- df.outcome.cbcl %>% 
      dplyr::rename(outcome = cbcl_scr_syn_internal_t)
  }
  df.outcome.cbcl$interview_age <- as.numeric(df.outcome.cbcl$interview_age)
  df.outcome.cbcl$outcome <- df.outcome.cbcl$outcome %>% as.numeric() 
  return(df.outcome.cbcl)
}
```

# Demographic tables
Get the tables for Aim 1, Aim 2, and those who were dropped going from Aim 1 to Aim 2.
```{r}
# Get p-values
pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a standard 2-sample t-test
        p <- t.test(y ~ g)$p.value %>% p.adjust(method = "bonferroni", n = 8)
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g))$p.value %>% p.adjust(method = "bonferroni", n = 8)
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}

my.render.cont <- function(x) {
    with(stats.default(x), 
         c("",
           
          "Mean (SD)" = sprintf("%s (%s)",
                                round_pad(MEAN, 3),
                                round_pad(SD, 3)),
         
          "Median (Min, Max)" = sprintf("%s (%s, %s)",
                                       round_pad(MEDIAN, 3), 
                                       round_pad(MIN, 3), 
                                       round_pad(MAX, 3)))
    )
}

# id.aim1 = (merge_data(NULL) %>% 
#              filter_data(outcome = FALSE, pffr = TRUE))$subjectkey %>% 
#  unique()
#id.ksads = (merge_data(df.outcome.ksads) %>% 
#              filter_data(outcome = TRUE, pffr = FALSE))$subjectkey %>% 
 # unique()
cbcl.fn = '~/Box/ABCD STUDY/ABCDStudy 4.0 Release/Raw data files/abcd_cbcls01.txt'
#id.cbcl = (get_cbcl(cbcl.fn, raw=TRUE) %>%
  #merge_data() %>% filter_data(outcome = TRUE, pffr = FALSE))$subjectkey %>% 
  #unique()
# all.equal(id.ksads,id.cbcl)

dat.ksads = merge_data(df.outcome.ksads) %>% 
              filter_data(outcome = FALSE, pffr = TRUE)
dat.ksads$outcome = dat.ksads$outcome %>% as.factor
dat.cbcl = get_cbcl(cbcl.fn, raw=TRUE) %>%
  merge_data() %>% 
  filter_data(outcome = FALSE, pffr = TRUE)

df.aim1 = merge_data(NULL) %>%
  filter_data(outcome = FALSE, pffr = TRUE) 
df.aim1$demo_sex_v2 = df.aim1$demo_sex_v2 %>% droplevels()
df.aim1$demo_ethn_v2 = df.aim1$demo_ethn_v2 %>% droplevels()
df.aim1$demo_prnt_marital_v2 = df.aim1$demo_prnt_marital_v2 %>% droplevels()
df.aim1$ksads = dat.ksads$outcome
df.aim1$cbcl = dat.cbcl$outcome
df.aim1$Race_Asian = df.aim1$Race_Asian %>% as.factor()
df.aim1$Race_White = df.aim1$Race_White %>% as.factor()
df.aim1$Race_Black = df.aim1$Race_Black %>% as.factor()
df.aim1$Race_Native = df.aim1$Race_Native %>% as.factor()
df.aim1$Race_PacificIslander = df.aim1$Race_PacificIslander %>% as.factor()
df.aim1$Race_Other = df.aim1$Race_Other %>% as.factor()

#df.aim1 %>%
#  arrange(interview_age) %>%
#  left_join(deap.covars %>%
#              filter(event_name == 'baseline_year_1_arm_1') %>%
#              dplyr::select(subjectid,age) %>%
#              rename(baseline_age = age,
#                     subjectkey = subjectid),
#            by = c('subjectkey'))

df.baseline = df.aim1 %>%
  arrange(interview_age) %>%
  group_by(subjectkey) %>%
  filter(row_number() == 1) %>%
  left_join(pdem02 %>%
              dplyr::select(subjectkey,interview_age) %>%
              dplyr::rename(baseline_age = interview_age), 
            by = 'subjectkey') %>%
  mutate(baseline_age = as.numeric(baseline_age)) %>% 
  left_join(dtp %>%
              dplyr::select(subjectkey,interview_age,pds) %>%
              group_by(subjectkey) %>%
              filter(row_number() == 1) %>%
              dplyr::rename(baseline_pds = pds,
                            baseline_age = interview_age),
            by= c('subjectkey','baseline_age')) %>%
  mutate(demo_sex_v2 = fct_recode(demo_sex_v2,
                              "Male" = "1",
                              "Female" = "2"))

table1(~baseline_age+baseline_pds+demo_prnt_marital_v2+demo_ed_highest+
         Race_White + Race_Black + Race_Asian + Race_Native + Race_PacificIslander + Race_Other + demo_ethn_v2 +
         ksads + cbcl | demo_sex_v2,
       data = df.baseline,
       overall = F,
       render.continuous = my.render.cont,
       extra.col=list(`P-value`=pvalue))

df.year2 = df.aim1 %>%
  arrange(interview_age) %>%
  left_join(deap.covars %>% 
              rename(subjectkey = subjectid,
                     interview_age = age),
            by=c('subjectkey','interview_age')) %>%
  filter(event_name == '2_year_follow_up_y_arm_1') %>%
  mutate(demo_sex_v2 = fct_recode(demo_sex_v2,
                              "Male" = "1",
                              "Female" = "2"))

table1(~interview_age+pds+demo_prnt_marital_v2+demo_ed_highest+
         Race_White + Race_Black + Race_Asian + Race_Native + Race_PacificIslander + Race_Other  + demo_ethn_v2 +
         ksads + cbcl | demo_sex_v2,
       data = df.year2,
       overall = F,
       render.continuous = my.render.cont,
       extra.col=list(`P-value`=pvalue))

# Aim 2 sample
subjectkey.ksads = (merge_data(df.outcome.ksads) %>% 
              filter_data(outcome = TRUE, pffr = FALSE))$subjectkey
subjectkey.cbcl = (get_cbcl(cbcl.fn, raw=TRUE) %>%
                     merge_data() %>% 
                     filter_data(outcome = TRUE, pffr = FALSE))$subjectkey

df.ga.baseline = df.baseline %>%
  filter((subjectkey %in% union(subjectkey.ksads %>% unique,
                                subjectkey.cbcl %>% unique))) 
df.diff = df.baseline %>%
  filter(!(subjectkey %in% union(subjectkey.ksads %>% unique,
                                 subjectkey.cbcl %>% unique))) 

table1(~baseline_age+demo_sex_v2+baseline_pds+demo_prnt_marital_v2+demo_ed_highest+
         Race_White + Race_Black + Race_Native + Race_PacificIslander + Race_Asian + Race_Other + demo_ethn_v2 +
         ksads + cbcl,
       data = df.baseline,
       render.continuous = my.render.cont)
# df.aim1[,c('Race_White' ,'Race_Black','Race_Asian','Race_Native','Race_PacificIslander','Race_Other')] %>% colSums()
# sum(df.aim1$ksads==0,na.rm=TRUE)
# sum(df.aim1$ksads==1,na.rm=TRUE)
# sum(is.na(df.aim1$ksads))

table1(~baseline_age+demo_sex_v2+baseline_pds+demo_prnt_marital_v2+demo_ed_highest+
         Race_White + Race_Black + Race_Native + Race_PacificIslander + Race_Asian + Race_Other + demo_ethn_v2 +
         ksads + cbcl,
       data = df.diff,
       render.continuous = my.render.cont)
# df.diff[,c('Race_White' ,'Race_Black','Race_Asian','Race_Native','Race_PacificIslander','Race_Other')] %>% colSums()
# sum(df.diff$ksads==0,na.rm=TRUE)
# sum(df.diff$ksads==1,na.rm=TRUE)
# sum(is.na(df.aim2$ksads))


# table1(~baseline_age+demo_sex_v2+baseline_pds+demo_prnt_marital_v2+demo_ed_highest+
#          Race_White + Race_Black + Race_Native + Race_PacificIslander + Race_Asian + Race_Other + demo_ethn_v2 +
#          ksads + cbcl,
#        data = df.aim2.baseline,
#        render.continuous = my.render.cont)
# 
# table1(~baseline_age+baseline_pds+demo_prnt_marital_v2+demo_ed_highest+
#          Race_White + Race_Black + Race_Native + Race_PacificIslander + Race_Asian + Race_Other + demo_ethn_v2 +
#          ksads + cbcl | demo_sex_v2,
#        data = df.aim2.baseline,
#        overall = F,
#        render.continuous = my.render.cont,
#        extra.col=list(`P-value`=pvalue))
# # df.aim2[,c('Race_White' ,'Race_Black','Race_Asian','Race_Native','Race_PacificIslander','Race_Other')] %>% colSums()
# # sum(df.aim2$ksads==0,na.rm=TRUE)
# # sum(df.aim2$ksads==1,na.rm=TRUE)
# # sum(is.na(df.aim2$ksads))
# 
# df.aim2.year2 = dat.ksads %>%
#   dplyr::rename(ksads = outcome) %>%
#   left_join(dat.cbcl %>%
#                dplyr::select(subjectkey,interview_age,outcome) %>%
#                dplyr::rename(cbcl = outcome),
#              by = c('subjectkey','interview_age')) %>%
#   filter(eventname == '2_year_follow_up_y_arm_1') %>%
#   filter((subjectkey %in% union(subjectkey.ksads %>% unique,
#                                 subjectkey.cbcl %>% unique))) 
# 
# table1(~ksads + cbcl | demo_sex_v2,
#        data = df.aim2.year2,
#        overall = F,
#        render.continuous = my.render.cont,
#        extra.col=list(`P-value`=pvalue))


```

## The statistical model
The statistical model we will use is either a logistic regression model (for binary outcomes) or a linear mixed model (for continuous outcomes). The reason that we do not use a generalized mixed model for the binary outcomes is that there isn't enough within-site/within-family variation for the random effects, leading to a model that overfits; so we use a ``vanilla'' logistic regression for those. However, for the continuous outcomes (CBCL) there's enough variation for the nested random effects.
```{r, echo=FALSE}
clinical.analysis = function(df.all,labels,logistic=FALSE,three.way = FALSE){
  results = list()
  model.fit = rep(NA,length(labels))
  if(three.way){
    results.all = list(roi.change = NULL,
                     pds.change = NULL,
                     roi.change_pds.change = NULL,
                     sex_roi.change = NULL,
                     sex_pds.change = NULL,
                     sex_roi.change_pds.change = NULL)
  }
  else{
    results.all = list(roi.change = NULL,
                     pds.change = NULL,
                     roi.change_pds.change = NULL,
                     sex_roi.change = NULL,
                     sex_pds.change = NULL)
  }
  
  counter = 1
  for(roi in labels){
    if(logistic){
      if(three.way){
        results[[counter]] <- glm(paste0("outcome_2 ~ outcome_1 + demo_sex_v2 + interview_age_1 + time.since.baseline_2 + pds_1 + 
      pds.change + roi.baseline*demo_sex_v2 + roi.change*pds.change+roi.change*demo_sex_v2 + pds.change*demo_sex_v2 + pds.change*roi.change*demo_sex_v2 +
                              demo_comb_income_v2 + demo_ethn_v2 + demo_ed_highest + demo_prnt_marital_v2 + mri_info_manufacturer +
                              Race_White + Race_Black + Race_Native+Race_PacificIslander+Race_Asian+Race_Other" ),
                       family = "binomial",
                       data = df.all %>% 
        dplyr::select(subjectkey,demo_sex_v2,roi,outcome,interview_age,time.since.baseline,pds,
                                    demo_ethn_v2,demo_comb_income_v2,demo_prnt_marital_v2,demo_ed_highest,
                                       mri_info_manufacturer,Race_White:Race_Other,fsqc_qc,
                                       abcd_site,rel_family_id) %>%
                         group_by(subjectkey) %>% 
                         mutate(visit=1:n()) %>% 
                         pivot_wider(names_from = visit, 
                                     values_from = c("outcome","pds","interview_age",roi,fsqc_qc,time.since.baseline)) %>%
                         dplyr::rename(roi.baseline = paste0(roi,"_1")) %>%
                         mutate(roi.change = (!!as.name(paste0(roi,"_2"))) - roi.baseline) %>%
                         mutate(pds.change = pds_2 - pds_1))
      }
      else{
        results[[counter]] <- glm(paste0("outcome_2 ~ outcome_1 + demo_sex_v2 + interview_age_1 + time.since.baseline_2 + pds_1 + 
        pds.change + roi.baseline*demo_sex_v2 + roi.change*pds.change+roi.change*demo_sex_v2 + pds.change*demo_sex_v2 + 
                                demo_comb_income_v2 + demo_ethn_v2 + demo_ed_highest + demo_prnt_marital_v2 + mri_info_manufacturer +
                                Race_White + Race_Black + Race_Native+Race_PacificIslander+Race_Asian+Race_Other" ),
                         family = "binomial",
                         data = df.all %>% 
                           dplyr::select(subjectkey,demo_sex_v2,roi,outcome,interview_age,time.since.baseline,pds,
                                      demo_ethn_v2,demo_comb_income_v2,demo_prnt_marital_v2,demo_ed_highest,
                                         mri_info_manufacturer,Race_White:Race_Other,fsqc_qc,
                                         abcd_site,rel_family_id) %>%
                           group_by(subjectkey) %>% 
                           mutate(visit=1:n()) %>% 
                           pivot_wider(names_from = visit, 
                                       values_from = c("outcome","pds","interview_age",roi,fsqc_qc,time.since.baseline)) %>%
                           dplyr::rename(roi.baseline = paste0(roi,"_1")) %>%
                           mutate(roi.change = (!!as.name(paste0(roi,"_2"))) - roi.baseline) %>%
                           mutate(pds.change = pds_2 - pds_1))
      }
      model.fit[counter] = 1-results[[counter]]$deviance/results[[counter]]$null.deviance
    }
    else{
      if(three.way){
        results[[counter]] <- lmer(paste0("outcome_2 ~ outcome_1 + demo_sex_v2 + interview_age_1 + time.since.baseline_2 + pds_1 + 
        pds.change + roi.baseline*demo_sex_v2 + roi.change*pds.change+roi.change*demo_sex_v2 + pds.change*demo_sex_v2 + pds.change*demo_sex_v2*roi.change +
                                demo_comb_income_v2 + demo_ethn_v2 + demo_ed_highest + demo_prnt_marital_v2  + 
                                Race_White + Race_Black + Race_Native+Race_PacificIslander+Race_Asian+Race_Other + 
                               (1|abcd_site/rel_family_id)" ),
        data = df.all %>% 
          dplyr::select(subjectkey,demo_sex_v2,roi,outcome,interview_age,time.since.baseline,pds,
                        demo_ethn_v2,demo_comb_income_v2,demo_prnt_marital_v2,demo_ed_highest,
                        mri_info_manufacturer,Race_White:Race_Other,fsqc_qc,
                        abcd_site,rel_family_id) %>%
          group_by(subjectkey) %>% 
          mutate(visit=1:n()) %>% 
          pivot_wider(names_from = visit, 
                      values_from = c("outcome","pds","interview_age",roi,fsqc_qc,time.since.baseline)) %>%
          dplyr::rename(roi.baseline = paste0(roi,"_1")) %>% 
          mutate(roi.change = (!!as.name(paste0(roi,"_2"))) - roi.baseline) %>%
          mutate(pds.change = pds_2 - pds_1))
      }
      else{
        results[[counter]] <- lmer(paste0("outcome_2 ~ outcome_1 + demo_sex_v2 + interview_age_1 + time.since.baseline_2 + pds_1 + 
        pds.change + roi.baseline*demo_sex_v2 + roi.change*pds.change+roi.change*demo_sex_v2 + pds.change*demo_sex_v2 + 
                                demo_comb_income_v2 + demo_ethn_v2 + demo_ed_highest + demo_prnt_marital_v2  + 
                                Race_White + Race_Black + Race_Native+Race_PacificIslander+Race_Asian+Race_Other + 
                               (1|abcd_site/rel_family_id)" ),
        data = df.all %>% 
          dplyr::select(subjectkey,demo_sex_v2,roi,outcome,interview_age,time.since.baseline,pds,
                        demo_ethn_v2,demo_comb_income_v2,demo_prnt_marital_v2,demo_ed_highest,
                        mri_info_manufacturer,Race_White:Race_Other,fsqc_qc,
                        abcd_site,rel_family_id) %>%
          group_by(subjectkey) %>% 
          mutate(visit=1:n()) %>% 
          pivot_wider(names_from = visit, 
                      values_from = c("outcome","pds","interview_age",roi,fsqc_qc,time.since.baseline)) %>%
          dplyr::rename(roi.baseline = paste0(roi,"_1")) %>% 
          mutate(roi.change = (!!as.name(paste0(roi,"_2"))) - roi.baseline) %>%
          mutate(pds.change = pds_2 - pds_1))  
      }
      model.fit[counter] = r.squaredGLMM(results[[counter]])[1,2] # Conditional R2, which is variance explained by both fixed and random effects
    }
    
    if(logistic){pval = 'Pr(>|z|)'}
    else{pval = 'Pr(>|t|)'}
    
    df.results = results[[counter]] %>% 
      summary() %>%
      coefficients() %>%
      as.data.frame()
    if(three.way){
      df.results = df.results %>%
      dplyr::filter(row.names(df.results) %in% c("roi.change","pds.change","pds.change:roi.change","demo_sex_v22:roi.change","demo_sex_v22:pds.change", "demo_sex_v22:pds.change:roi.change"))
    }
    else{
      df.results = df.results %>%
      dplyr::filter(row.names(df.results) %in% c("roi.change","pds.change","pds.change:roi.change","demo_sex_v22:roi.change","demo_sex_v22:pds.change"))  
    }
    
    results.all$roi.change = rbind(results.all$roi.change,
                                   df.results['roi.change',c('Estimate',pval)])
    results.all$pds.change = rbind(results.all$pds.change,
                                   df.results['pds.change',c('Estimate',pval)])
    results.all$roi.change_pds.change = rbind(results.all$roi.change_pds.change,
                                              df.results['pds.change:roi.change',c('Estimate',pval)])
    results.all$sex_roi.change = rbind(results.all$sex_roi.change,
                                       df.results['demo_sex_v22:roi.change',c('Estimate',pval)])
    results.all$sex_pds.change = rbind(results.all$sex_pds.change,
                                       df.results['demo_sex_v22:pds.change',c('Estimate',pval)])
    if(three.way){
      results.all$sex_roi.change_pds.change = rbind(results.all$sex_roi.change_pds.change,
                                       df.results['demo_sex_v22:pds.change:roi.change',c('Estimate',pval)])
    }
    counter = counter + 1
  }
  
  # Relabel the row names
  results.all = lapply(results.all,
                       function(x){rownames(x)<-labels; x})
  # Include the models in case we need to do more postprocessing
  results.all$models = results
  results.all$model.fit = data.frame(labels = labels, 
                                     R2s = model.fit)
  
  return(results.all)
}
```

## Results from KSADS
First we look at the KSADS data. We create a composite binary outcome, and then run the logistic regression model. We fit separate models across ROIs. And so we can look at the model fit for a single ROI or look at the ROI effects across all models. P-values adjusted using the Bonferroni correction.
```{r,echo=FALSE}
# df.outcome.ksads$subjectkey%>% unique() %>% length() # Number of kids with ksads data
results.ksads = clinical.analysis(merge_data(df.outcome.ksads) %>% filter_data(),
                                  cb3.lme.covar$label,
                                  logistic=TRUE,
                                  three.way = FALSE)
```

### Reporting regression results - KSADS
The following shows all coefficients for each regression model. Note that _1 denotes baseline, and _2 denotes follow-up. Please see the data dictionary for the coding of the categorical variables (suffixed at the end of each categorical variable).
```{r, echo = FALSE, results='asis'}
tables_ksads = function(results, label){
  for(j in 1:length(results$models)){
    dust(results$models[[j]]) %>%
      sprinkle(col=2:4,round=3) %>%
      sprinkle(col=5,fn=quote(pvalString(value))) %>%
      sprinkle_colnames(term = "Term",
                        estimate= "Estimate",
                        std.error = "SE",
                        statistic = "Z-statistic",
                        p.value = "p-value") %>%
      knitr::kable(caption = paste0(label[j], 
                                    " Pseudo R^2 = ", 
                                    results$model.fit[j,"R2s"] %>% round(digits = 3))) %>%
      kable_styling() %>%
      print()
    cat('\n\n<!-- -->\n\n')
  }  
}
tables_ksads(results.ksads, cb3.lme.covar$label)
```

```{r}
get.effects = function(results,logistic=TRUE,label){
  # models is a list of models. We'll extract 2 rows (baseline + change score) per model
  df.estimates = data.frame(estimate=NULL,conf.low = NULL,conf.high = NULL)
  for(j in 1:length(results$models)){
    roi.name = label[j] %>% substring(4)
    if(logistic){
      # df.est = logistic.display(results$models[[j]])$table[c(8,28),c('OR','lower95ci','upper95ci')]
      df.est = logistic.display(results$models[[j]])$table %>% as.data.frame()
      df.est = df.est %>% 
        dplyr::select(OR,lower95ci,upper95ci) %>% 
        filter(rownames(df.est) %in% c('roi.change','demo_sex_v22:roi.change'))#,
                                       #'pds.change','demo_sex_v22:pds.change'))
    }
    else{
      std.params = standardize_parameters(results$models[[j]]) %>% # Use the effectsize package
        as.data.frame()
      df.est = std.params %>%
        dplyr::select(Parameter,Std_Coefficient,CI_low,CI_high) %>%
        filter(Parameter %in% c('roi.change','demo_sex_v22:roi.change'))
      df.est = df.est %>%
        dplyr::select(Std_Coefficient,CI_low,CI_high)
      #df.est = data.frame(effect = std.params$Std_Coefficient[c(9,27)],
      #                    lower95ci = std.params$CI_low[c(9,27)],
      #                    upper95ci = std.params$CI_high[c(9,27)])
    }
    # roi.name = substring(roi.name,1,nchar(roi.name)-2)
    rownames(df.est) = c(#paste0("Change - PDS"),
                         paste0("Change - ",roi.name),
                         paste0("Sex : ","(Change - ",roi.name,")"))#,
                         #paste0("Sex : PDS"))
    df.estimates = df.estimates %>% 
      rbind(df.est)
  }
  if(logistic){
    colnames(df.estimates) = c("OR","lower95ci","upper95ci")  
  }
  else{
    colnames(df.estimates) = c("std.effect","lower95ci","upper95ci")  
  }
  return(df.estimates)
}
df.ors = get.effects(results.ksads,logistic=TRUE,cb3.lme.covar$label)
df.ors

tidy_ors <- transform_results(df.ors)
tidy_ors.filtered = tidy_ors %>% 
  filter(Effect == "Sex x CT Change Interaction")

forest_plots <- make_forest_plot(tidy_ors.filtered %>% 
                                  slice(order(factor(roi,roi.order))),
                                 log.ors = TRUE)
forest_plots
tidy_ors.filtered = tidy_ors %>% 
  filter(Effect == "Main Effect CT Change")
forest_plots <- make_forest_plot(tidy_ors.filtered %>%
                                   slice(order(factor(roi,roi.order))),
                                 log.ors = TRUE)
forest_plots
#forest.plot <- ggplot(data=df.ors, aes(x=rownames(df.ors), y=OR, ymin=lower95ci, ymax=upper95ci)) +
#  geom_pointrange() + 
#  geom_hline(yintercept=1, lty=2) +  # add a dotted line at x=1 after flip
#        coord_flip() +  # flip coordinates (puts labels on y axis)
#        xlab("Average Cortical Thickness") + ylab("Adjusted Odds Ratios") +
#        theme_bw()  # use a white background
#forest.plot
```


```{r proportions, echo=FALSE, results = 'hide'}
#merge_data(df.outcome.ksads) %>%
#  filter_data() %>%
#  group_by(abcd_site) %>%
#  dplyr::summarize(prop = mean(outcome,na.rm=TRUE), n=n()) %>% 
#  print(n=22)
```

## Results from CBCL
Next we look at the CBCL (internalizing) data. We'll look at both raw and t-scores. In the latest iteration of this, the LMER output a warning when analyzing the precuneus data. After looking into this, it seems that the site random effect is close to null, leading to the warning. Indeed, removing the site random effect did not yield a warning, and so the site random effect is the likely culprit. To reiterate, the model still fit with the site random effect, though the warning is essentially suggesting that that random effect may not be necessary.
```{r,warning=FALSE}
cbcl.fn = '~/Box/ABCD STUDY/ABCDStudy 4.0 Release/Raw data files/abcd_cbcls01.txt'
results.raw = clinical.analysis(get_cbcl(cbcl.fn, raw = TRUE) %>%
                              merge_data() %>% 
                              filter_data(),
                            cb3.lme.covar$label,
                            logistic=FALSE,
                            three.way = FALSE)
results.t = clinical.analysis(get_cbcl(cbcl.fn, raw = FALSE) %>%
                              merge_data() %>% 
                              filter_data(),
                            cb3.lme.covar$label,
                            logistic=FALSE,
                            three.way = FALSE)
```

### Reporting regression results
Again we show all coefficients for each regression model. Note that _1 denotes baseline, and _2 denotes follow-up. Please see the data dictionary for the coding of the categorical variables (suffixed at the end of each categorical variable). The first set of tables will be for the raw scores, and the second set for the t-scores.
```{r, results='asis'}
tables_cbcl = function(results, label){
  for(j in 1:length(results$models)){
    results$models[[j]] %>% 
      summary() %>% 
      coefficients() %>%
      as.data.frame() %>%
      mutate(term = results$models[[j]] %>% 
               summary() %>% 
               coefficients() %>% 
               rownames(),
             .before = Estimate) %>%
      dplyr::select(-4) %>%
      dust() %>%
      sprinkle(col=2:4,round=3) %>%
      sprinkle(col=5,fn=quote(pvalString(value))) %>%
      sprinkle_colnames("Term",
                        "Estimate",
                        "SE",
                        "t-statitic",
                        "p-value") %>%
      kable(caption = paste0(label[j], 
                             " Conditional R^2 = ", 
                             results$model.fit[j,"R2s"] %>% round(digits = 3))) %>%
      kable_styling() %>%
      print()
    cat('\n\n<!-- -->\n\n')
    
    } 
}
print('Results from raw scores')
tables_cbcl(results.raw, cb3.lme.covar$label)
print('Results from t scores')
tables_cbcl(results.t, cb3.lme.covar$label)
```

Below are the results of the models with standardized coefficients for the analysis on the raw scores.
```{r}
df.betas = get.effects(results.raw,logistic = FALSE,cb3.lme.covar$label)
df.betas
#forest.plot <- ggplot(data=df.betas, aes(x=rownames(df.betas), y=std.effect, ymin=lower95ci, ymax=upper95ci)) +
  #geom_pointrange() + 
  #geom_hline(yintercept=0, lty=2) +  # add a dotted line at x=0 after flip
  #      coord_flip() +  # flip coordinates (puts labels on y axis)
  #      xlab("Average Cortical Thickness") + ylab("Standardized Effects") +
  #      theme_bw()  # use a white background
#forest.plot
tidy_df = df.betas %>%
  transform_results() %>%
  filter(Effect == "Sex x CT Change Interaction")
forest_plots <- make_forest_plot(tidy_df %>%
                                   slice(order(factor(roi,roi.order))),
                                 betas = TRUE)
forest_plots
tidy_df = df.betas %>%
  transform_results() %>%
  filter(Effect == "Main Effect CT Change")
forest_plots <- make_forest_plot(tidy_df %>%
                                   slice(order(factor(roi,roi.order))),
                                 betas = TRUE)
forest_plots

```

Again, but this time using the t-scores.
```{r}
df.betas = get.effects(results.t,logistic = FALSE,cb3.lme.covar$label)
df.betas
tidy_df = df.betas %>%
  transform_results() %>%
  filter(Effect == "Sex x CT Change Interaction")
forest_plots <- make_forest_plot(tidy_df %>%
                                   slice(order(factor(roi,roi.order))),
                                 betas = TRUE)
forest_plots

#forest.plot <- ggplot(data=df.betas, aes(x=rownames(df.betas), y=std.effect, ymin=lower95ci, ymax=upper95ci)) +
#  geom_pointrange() + 
#  geom_hline(yintercept=0, lty=2) +  # add a dotted line at x=0 after flip
#        coord_flip() +  # flip coordinates (puts labels on y axis)
#        xlab("Average Cortical Thickness") + ylab("Standardized Effects") +
#        theme_bw()  # use a white background
#forest.plot
```

# Rerunning Analyses with the 3-way interaction
Rerun all Aim 2 analyses with a 3-way interaction of sex, pds, and cortical thickness change.

## KSADS with 3-way interaction
```{r, echo = FALSE, results='asis'}
results.ksads.3way = clinical.analysis(merge_data(df.outcome.ksads) %>% filter_data(),
                                  cb3.lme.covar$label,
                                  logistic=TRUE,
                                  three.way = TRUE)
tables_ksads(results.ksads.3way, cb3.lme.covar$label)
```

### Plots 
```{r, echo = FALSE}
tidy_ors = get.effects(results.ksads.3way,logistic=TRUE,cb3.lme.covar$label) %>%
  transform_results()
forest_plots <- make_forest_plot(tidy_ors %>% 
                                        filter(Effect == "Sex x CT Change Interaction") %>%
                                        arrange(estimate), log.ors = TRUE)

forest_plots
```

## CBCL with 3-way interaction
```{r, echo = FALSE, results='asis'}
cbcl.fn = '~/Box/ABCD STUDY/ABCDStudy 4.0 Release/Raw data files/abcd_cbcls01.txt'
results.raw.3way = clinical.analysis(get_cbcl(cbcl.fn, raw = TRUE) %>%
                              merge_data() %>% 
                              filter_data(),
                            cb3.lme.covar$label,
                            logistic=FALSE,
                            three.way = TRUE)
results.t.3way = clinical.analysis(get_cbcl(cbcl.fn, raw = FALSE) %>%
                              merge_data() %>% 
                              filter_data(),
                            cb3.lme.covar$label,
                            logistic=FALSE,
                            three.way = TRUE)
print('Results from raw scores')
tables_cbcl(results.raw.3way, cb3.lme.covar$label)
print('Results from t scores')
tables_cbcl(results.t.3way, cb3.lme.covar$label)
```

### Plots
```{r, echo = FALSE}
print('Forest plot from raw scores')
tidy_betas = get.effects(results.raw.3way,logistic = FALSE,cb3.lme.covar$label) %>%
  transform_results()
forest_plots <- make_forest_plot(tidy_betas %>%
                                   filter(Effect == "Sex x CT Change Interaction") %>%
                                   arrange(abs(estimate)), betas = TRUE)
forest_plots

print('Forest plot from t scores')
tidy_betas = get.effects(results.t.3way,logistic = FALSE,cb3.lme.covar$label) %>%
  transform_results()
forest_plots <- make_forest_plot(tidy_betas %>%
                                   filter(Effect == "Sex x CT Change Interaction") %>%
                                   arrange(abs(estimate)), betas = TRUE)
forest_plots
```