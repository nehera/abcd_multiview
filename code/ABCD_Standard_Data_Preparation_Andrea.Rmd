---
title: "Standard ABCD Data Preparation"
author: "Andrea Wiglesworth"
date: "2023-02-04"
output: html_document
---

Load Necessary Packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(purrr)
library(tidyr)
```

USE ONLINE CODEBOOK TO FIND THE LABELS FOR THE VARIABLES: 
https://docs.google.com/spreadsheets/d/1uHRrXASaxtZbRAeJvPJktqxyDkPdA2_WgxYdLTjhK1Q/edit?usp=sharing

Load Data Files
```{r}
# KAD 2/20: Would we want to consider adding a place to set a working directory to load in the data? 
# I suppose we assume people are always loading this from the 'ABCD Standard Data Preparation' directory, which is probably reasonable, but this would add a bit more flexibility in people saving it to project specific directories 
# But I'll put a suggestion below, which you should ignore if you want!
#home_dir <- '/Users/USERNAME/Library/CloudStorage/Box-Box/' # or '~/Library/CloudStorage/Box-Box/' But this will differ for Windows, so has to be user-specified anyway
#setwd(paste0(home_dir,'/ABCD STUDY/ABCD Standard Data Preparation/'))
# Note that this sets the working directory just in this chunk, which I think is what you'd want, but you could set it more globally for the document using knitr::root.dir (and have the first code chunk be variables the user needs to modify, if there are others)

#Standard files for most studies
demog_bl <- read.csv("pdem02.csv") #Baseline Demographics (Demographic Variables)
demog_long <- read.csv("abcd_lpds01.csv") #Longitudinal Demographics (Demographic Variables)
puberty <- read.csv("abcd_ssphp01.csv") #Pubertal Stage (Demographic Variables)
site <- read.csv("abcd_lt01.csv") #Site ID (ABCD Study Design Variables)
study_covars <- read.csv("acspsw03.csv") #Family ID and Propensity Weights (ABCD Study Design Variables)
mri <- read.csv("abcd_mri01.csv") #MRI Platform information (Neuroimaging Variables)
fsqc <- read.csv("freesqc01.csv") #MRI Freesurfer quality score (Neuroimaging Variables)

#Standard files for clinical data
cbcl <- read.csv("abcd_cbcls01.csv") #CBCL
ksad_p <- read.csv("abcd_ksad01.csv") #Parent ksads
ksad_t <- read.csv("abcd_ksad501.csv") #Teen ksads

#Delete first row (description of the variables)
demog_bl <- demog_bl[-1,]
demog_long <- demog_long[-1,]
puberty <- puberty[-1,]
site <- site[-1,]
study_covars <- study_covars[-1,]
mri <- mri[-1,]
fsqc <- fsqc[-1,]
cbcl <- cbcl[-1,]
ksad_p <- ksad_p[-1,]
ksad_t <- ksad_t[-1,]
```

Select Relevant Variables
```{r}
demog_bl <- demog_bl %>%
  select(subjectkey, eventname, demo_sex_v2, demo_gender_id_v2, demo_race_a_p___10,
         demo_race_a_p___11,demo_race_a_p___12, demo_race_a_p___13, demo_race_a_p___14,
         demo_race_a_p___15, demo_race_a_p___16, demo_race_a_p___17, demo_race_a_p___18,
         demo_race_a_p___19, demo_race_a_p___20, demo_race_a_p___21, demo_race_a_p___22,
         demo_race_a_p___23, demo_race_a_p___24, demo_race_a_p___25,demo_race_a_p___77, 
         demo_race_a_p___99, demo_ethn_v2, demo_prnt_marital_v2, demo_prnt_ed_v2, demo_prtnr_ed_v2,
         demo_comb_income_v2, demo_fam_exp1_v2, demo_fam_exp2_v2, demo_fam_exp3_v2,
         demo_fam_exp4_v2, demo_fam_exp5_v2, demo_fam_exp6_v2, demo_fam_exp7_v2, demo_roster_v2)

demog_long <- demog_long %>%
  select(subjectkey, eventname, interview_age, demo_gender_id_v2_l, demo_comb_income_v2_l, demo_roster_v2_l)

puberty <- puberty %>%
  select(subjectkey, eventname, pds_p_ss_male_category_2, pds_p_ss_female_category_2)

site <- site %>%
  select(subjectkey, eventname, site_id_l)

study_covars <- study_covars %>%
  select(subjectkey, eventname, rel_family_id, rel_group_id)
  
mri <- mri %>%
  select(subjectkey, eventname, mri_info_manufacturer)

fsqc <- fsqc %>%
  select(subjectkey, eventname, fsqc_qc)

cbcl <- cbcl %>%
  select(subjectkey, eventname, cbcl_scr_syn_internal_r, cbcl_scr_syn_external_r, cbcl_scr_syn_totprob_r,
         cbcl_scr_dsm5_depress_r, cbcl_scr_dsm5_anxdisord_r, cbcl_scr_dsm5_adhd_r,
         cbcl_scr_syn_internal_t, cbcl_scr_syn_external_t, cbcl_scr_syn_totprob_t,
         cbcl_scr_dsm5_depress_t, cbcl_scr_dsm5_anxdisord_t, cbcl_scr_dsm5_adhd_t)

ksad_p <- ksad_p %>%
  select(subjectkey, eventname, ksads_23_946_p, ksads_23_957_p, ksads_23_954_p, ksads_23_965_p, ksads_23_956_p,
         ksads_23_945_p, ksads_23_950_p, ksads_23_961_p, ksads_23_947_p, ksads_23_958_p, ksads_23_948_p,
         ksads_23_959_p, ksads_23_949_p, ksads_23_960_p, ksads_23_952_p, ksads_23_963_p, ksads_23_951_p,
         ksads_23_962_p, ksads_23_953_p, ksads_23_964_p)

ksad_t <- ksad_t %>%
  select(subjectkey, eventname, ksads_23_945_t, ksads_23_946_t, ksads_23_947_t, ksads_23_948_t, ksads_23_949_t,
         ksads_23_950_t, ksads_23_951_t, ksads_23_952_t, ksads_23_953_t, ksads_23_954_t, ksads_23_956_t, 
         ksads_23_957_t, ksads_23_958_t, ksads_23_959_t, ksads_23_960_t, ksads_23_961_t, ksads_23_962_t,
         ksads_23_963_t, ksads_23_964_t, ksads_23_965_t)

```


Merge into single file and replace missing data codes with NA (Can change this if you do not want that)
```{r}
files <- list(demog_bl, demog_long, puberty, site, study_covars, mri, fsqc, cbcl, ksad_p, ksad_t)

abcd_data <- files %>% reduce(full_join, by = c("subjectkey", "eventname"))

abcd_data <- na_if(abcd_data, 777)
abcd_data <- na_if(abcd_data, 999)
abcd_data <- na_if(abcd_data, 555)
abcd_data <- na_if(abcd_data, 888)
abcd_data <- na_if(abcd_data, "")
View(abcd_data)

```


Recode Race and Puberty Variables 
```{r}
abcd_data$White_race <- abcd_data$demo_race_a_p___10
abcd_data$Black_race <- abcd_data$demo_race_a_p___11
abcd_data$AIAN_race <- abcd_data$demo_race_a_p___12
abcd_data$AIAN_race[abcd_data$demo_race_a_p___13 == 1] <- 1
abcd_data$NHPI_race <- abcd_data$demo_race_a_p___14
abcd_data$NHPI_race[abcd_data$demo_race_a_p___15 == 1] <- 1
abcd_data$NHPI_race[abcd_data$demo_race_a_p___16 == 1] <- 1
abcd_data$NHPI_race[abcd_data$demo_race_a_p___17 == 1] <- 1
abcd_data$Asian_race <- abcd_data$demo_race_a_p___18
abcd_data$Asian_race[abcd_data$demo_race_a_p___19 == 1] <- 1
abcd_data$Asian_race[abcd_data$demo_race_a_p___20 == 1] <- 1
abcd_data$Asian_race[abcd_data$demo_race_a_p___21 == 1] <- 1
abcd_data$Asian_race[abcd_data$demo_race_a_p___22 == 1] <- 1
abcd_data$Asian_race[abcd_data$demo_race_a_p___23 == 1] <- 1
abcd_data$Asian_race[abcd_data$demo_race_a_p___24 == 1] <- 1
abcd_data$Other_race <- abcd_data$demo_race_a_p___25 
abcd_data$Missing_race <- abcd_data$demo_race_a_p___77
abcd_data$Missing_race[abcd_data$demo_race_a_p___99 == 1] <- 1
abcd_data$Missing_race[abcd_data$White_race == 1] <- 0
abcd_data$Missing_race[abcd_data$Black_race == 1] <- 0
abcd_data$Missing_race[abcd_data$AIAN_race == 1] <- 0
abcd_data$Missing_race[abcd_data$NHPI_race == 1] <- 0
abcd_data$Missing_race[abcd_data$Asian_race == 1] <- 0
abcd_data$Missing_race[abcd_data$Other_race == 1] <- 0
abcd_data$Indigenous_race <- abcd_data$AIAN_race
abcd_data$Indigenous_race[abcd_data$NHPI_race == 1] <- 1 #Indigenous may be desired instead of AIAN and NHPI when sample sizes are limited
abcd_data$demo_ethn_v2 <- dplyr::recode(abcd_data$demo_ethn_v2, "2" = "0")
abcd_data$Missing_race[abcd_data$demo_ethn_v2 == "1"] <- 0 #Individuals who do not have race or ethnicity data thus might need excluded when analyses control for race/ethnicity

# abcd_data$sex <- abcd_data$demo_sex_v2[abcd_data$eventname=="baseline_year_1_arm_1"]
# Mark's revision
#abcd_data$sex <- abcd_data$demo_sex_v2

# Mark's revision
# abcd_data$demo_sex_v2 %>% table() # Check that the only values are 1, 2, and 3
abcd_data <- abcd_data %>%
  mutate(pubertal_status = if_else(demo_sex_v2 == '1' | demo_sex_v2 == '3',
                                  pds_p_ss_male_category_2, # Set to this if the condition above is TRUE
                                  pds_p_ss_female_category_2)) # Otherwise set to this 


#Recoding to indicate highest education between parent and partner
abcd_data$demo_prnt_ed_v2 <- as.integer(abcd_data$demo_prnt_ed_v2)
abcd_data$demo_prtnr_ed_v2 <- as.integer(abcd_data$demo_prtnr_ed_v2)

abcd_data <- abcd_data %>%
  mutate(highest_demo_ed = if_else(is.na(demo_prtnr_ed_v2),
                                   demo_prnt_ed_v2, 
                                   if_else(demo_prnt_ed_v2 > demo_prtnr_ed_v2,
                                           demo_prnt_ed_v2, demo_prtnr_ed_v2)))

```


Create STB and NSSI variables
```{r}

abcd_data<- abcd_data %>%
	    mutate(SI_ever_t = factor(if_else(0 < (ksads_23_946_t==1) +
	                                      (ksads_23_947_t==1) + (ksads_23_948_t==1) + (ksads_23_949_t==1) +
	                                      (ksads_23_950_t==1), "present", 
	                                    if_else(0 < (ksads_23_957_t==1) + 
                                          (ksads_23_958_t==1) + (ksads_23_959_t==1) + (ksads_23_960_t==1) + 
                                          (ksads_23_961_t==1),"past","never")), 
	                            levels = c("never", "present", "past")))


abcd_data<- abcd_data %>%
	    mutate(SI_ever_p = factor(if_else(0 < (ksads_23_946_p==1) + (ksads_23_947_p==1) + (ksads_23_948_p==1) +
	                                      (ksads_23_949_p==1) + (ksads_23_950_p==1), "present", 
	                                    if_else(0 < (ksads_23_957_p==1) + (ksads_23_958_p==1) + (ksads_23_959_p==1) +
                                          (ksads_23_960_p==1) + (ksads_23_961_p==1),"past","never")), 
	                            levels = c("never", "present", "past")))


#This is my attempt at working around the NAs, but it is not working
abcd_data<- abcd_data %>%
	    mutate(SI_ever_p_t = factor(ifelse(is.na(SI_ever_p), SI_ever_t,
	                                        ifelse(is.na(SI_ever_t), SI_ever_p,
	                                                ifelse(SI_ever_p == "present" | SI_ever_t == "present",
	                                                        "present",
	                                                        ifelse(SI_ever_p == "past" | SI_ever_t == "past",
	                                                        "past", "never")))),
	                                 levels = c("never", "present", "past")))
	           

#this is the code that Chloe had, which does not work around the NAs (you can see there are many NAs in the composite variable). 
abcd_data<- abcd_data %>%
	    mutate(SI_ever_p_t = factor(if_else(0 < (ksads_23_946_p==1) + (ksads_23_947_p==1) + (ksads_23_948_p==1) +
	                                      (ksads_23_949_p==1) + (ksads_23_950_p==1) + (ksads_23_946_t==1) +
	                                      (ksads_23_947_t==1) + (ksads_23_948_t==1) + (ksads_23_949_t==1) +
	                                      (ksads_23_950_t==1), "present", 
	                                    if_else(0 < (ksads_23_957_p==1) + (ksads_23_958_p==1) + (ksads_23_959_p==1) +
                                          (ksads_23_960_p==1) + (ksads_23_961_p==1) + (ksads_23_957_t==1) + 
                                          (ksads_23_958_t==1) + (ksads_23_959_t==1) + (ksads_23_960_t==1) + 
                                          (ksads_23_961_t==1),"past","never")), 
	                            levels = c("never", "present", "past")))

```

Remove the time points you do not want, rename the file with each time point removed
```{r Remove unwanted events}

table(abcd_data$eventname) #This will tell you the time points currently included in the data 

#Below is code to remove all six month time points:
abcd_data.1 <- abcd_data[abcd_data$eventname != "42_month_follow_up_arm_1",]
abcd_data.2 <- abcd_data.1[abcd_data.1$eventname != "30_month_follow_up_arm_1",]
abcd_data.3 <- abcd_data.2[abcd_data.2$eventname != "18_month_follow_up_arm_1",]
abcd_data.4 <- abcd_data.3[abcd_data.3$eventname != "6_month_follow_up_arm_1"]


```


Write your own file to merge with your other variables of interest
```{r write dataset}
write.csv(abcd_data.X, "[Date]_[YourInitials].csv") #Update X based on whatever dataset version you are on
```


Reformat to wide data if desired
```{r Wide format if desired}

#-----------------------------------------------------
#     Be sure to paste all variable names
#     to be included at each time point into
#     the "select()" call for each data subset
#------------------------------------------------------

data_BL <- abcd_data[abcd_data$eventname == "baseline_year_1_arm_1",]
data_BL <- data_BL %>%
  select(subjectkey, ) #enter all of the variable names you'd like pulled from BL into the list within parentheses
names(data_BL) <- paste(names(data_BL), "_BL", sep = "")
data_BL <- dplyr::rename(data_BL, subjectkey = subjectkey_BL) #rename subjectkey to maintain consistency across time points for merging

data_Y1 <- abcd_data[abcd_data$eventname == "1_year_follow_up_y_arm_1",]
data_Y1 <- data_Y1 %>%
  select(subjectkey, ) #enter all of the variable names you'd like pulled from Year 1
names(data_Y1) <- paste(names(data_Y1), "_Y1", sep = "")
data_Y1 <- dplyr::rename(data_Y1, subjectkey = subjectkey_Y1) #rename subjectkey to maintain consistency across time points for merging

data_Y2 <- abcd_data[abcd_data$eventname == "2_year_follow_up_y_arm_1",]
data_Y2 <- data_Y2 %>%
  select(subjectkey, ) #enter all of the variable names you'd like pulled from Year 2
names(data_Y2) <- paste(names(data_Y2), "_Y2", sep = "")
data_Y2 <- dplyr::rename(data_Y2, subjectkey = subjectkey_Y2) #rename subjectkey to maintain consistency across time points for merging

data_Y3 <- abcd_data[abcd_data$eventname == "3_year_follow_up_y_arm_1",]
data_Y3 <- data_Y3 %>%
  select(subjectkey, ) #enter all of the variable names you'd like pulled from Year 2
names(data_Y3) <- paste(names(data_Y3), "_Y3", sep = "")
data_Y3 <- dplyr::rename(data_Y3, subjectkey = subjectkey_Y3) #rename subjectkey to maintain consistency across time points for merging

#--------------------------------------------------------
#  Can repeat for any additional data time points needed (e.g., 18 mo follow up) 
# Below is code for merging and writing the file 
#--------------------------------------------------------

data_years <- list(data_BL, data_Y1, data_Y2, data_Y3)
abcd_wide <- data_years %>% reduce(full_join, by = "subjectkey")

#To double check that there are no errors (e.g., no repeats of a grid since all individuals should have one row)
length(unique(abcd_wide$subjectkey)) == nrow(abcd_wide) #Should return "TRUE", if returns FALSE, there is a duplicate row and troubleshooting is needed.

#Write yourself a file to use for your project
write.csv(abcd_wide, "[Date]_[YourInitials].csv")

```

